import{localizationManager}from"./LocalizationManager.js";import*as Log from"../API/Log.js";export class SymbolTypeLocalizedText extends TcHmi.Destroyable{constructor(symbol){super(),this.__symbol=symbol,this.__symbolExpressionString=this.__symbol.getExpression().toString(),this.__symbolDiagGUID=this.__symbol.getDiagGUID()}__symbol;__symbolExpressionString;__symbolDiagGUID;__printExpression(expression){let message=this.__symbolExpressionString;return expression?(this.__symbolExpressionString!==expression.toString()&&(message+=` (Resolved to: '${expression.toString()}')`),message):message}destroy(){this.isDestroyed()||(this.__releaseDestroyPrivilege(),this.isDestroyable()&&(this.__symbol=null))}read(expression,options,callback){if(!this.__symbol)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeLocalizedText"}});if(!localizationManager)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYSTEM_NOT_READY,details:{code:TcHmi.Errors.E_SYSTEM_NOT_READY,message:TcHmi.Errors[TcHmi.Errors.E_SYSTEM_NOT_READY],reason:this.__printExpression(expression)+": Failed to read. System not ready.",domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});let name,localizationNamespace="TcHmi.System.Localization.Application",pathTokens=tchmi_clone_object(expression.getPathTokens());if(pathTokens&&0!==pathTokens.length){let namespaceToken=expression.getName();if(!namespaceToken)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name of the symbol.",domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(namespaceToken.startsWith("Control")){if(2!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Control" localization symbol expressions must be in the form: Control::[Control-Type]::[Key]',domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});localizationNamespace="TcHmi.System.Localization.Control<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Function")){if(2!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Function" localization symbol expressions must be in the form: Function::[Function-Name]::[Key]',domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});localizationNamespace="TcHmi.System.Localization.Function<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Package")){if(2!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Package" localization symbol expressions must be in the form: Package::[Package-Name]::[Key]',domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});localizationNamespace="TcHmi.System.Localization.Package<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Framework")){if(1!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Framework" localization symbol expressions must be in the form: Framework::[Key]',domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});localizationNamespace="TcHmi.System.Localization.Framework",name=pathTokens.shift()}else{if(!namespaceToken.startsWith("Application"))return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Path tokens are allowed only if the localization symbol expression starts with one of the following tokens: "Application", "Control", "Function" or "Framework".',domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});if(1!==pathTokens.length)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Explicit "Application" localization symbol expressions must be in the form: Application::[Key]',domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});localizationNamespace="TcHmi.System.Localization.Application",name=pathTokens.shift()}}else name=expression.getName();if(!name)return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Expression is invalid. Parser was unable to resolve the name and namespace of the symbol.",domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression});let text=localizationManager.getText(localizationNamespace,name);if(null!=text)try{return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.NONE,value:text,expressionResolved:expression,expression:this.__symbol.getExpression()})}catch(e){return void TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_EXCEPTION,details:{code:TcHmi.Errors.E_EXCEPTION,message:TcHmi.Errors[TcHmi.Errors.E_EXCEPTION],reason:this.__printExpression(expression)+": An uncaught exception occurred in the callback for the read operation",exception:e,domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression})}else TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_UNKNOWN,details:{code:TcHmi.Errors.E_SYMBOL_UNKNOWN,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_UNKNOWN],reason:this.__printExpression(expression)+": Failed to resolve localized text for this expression.",domain:"TcHmi.System.SymbolTypeLocalizedText"},expression:this.__symbol.getExpression(),expressionResolved:expression})}watch(expression,options,callback,reason){if(!this.__symbol)return TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeLocalizedText"}}),()=>{};let destroySubWatch,diagGUID="";(TCHMI_CONSOLE_LOG_LEVEL>=4||TCHMI_PERSISTENT_LOG_LEVEL>=4)&&(diagGUID=tchmi_create_guid());let destroy=()=>{Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression="+this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch destroy called."),destroySubWatch&&(destroySubWatch(),destroySubWatch=null)};if(!localizationManager)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYSTEM_NOT_READY,details:{code:TcHmi.Errors.E_SYSTEM_NOT_READY,message:TcHmi.Errors[TcHmi.Errors.E_SYSTEM_NOT_READY],reason:this.__printExpression(expression)+": Failed to watch. System not ready.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression}),destroy;let name,localizationNamespace="TcHmi.System.Localization.Application",pathTokens=tchmi_clone_object(expression.getPathTokens());if(pathTokens&&0!==pathTokens.length){let namespaceToken=expression.getName();if(namespaceToken)if(namespaceToken.startsWith("Control")){if(2!==pathTokens.length)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Control" localization symbol expressions must be in the form: Control::[Control-Type]::[Key]',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;localizationNamespace="TcHmi.System.Localization.Control<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Function")){if(2!==pathTokens.length)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Function" localization symbol expressions must be in the form: Function::[Function-Name]::[Key]',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;localizationNamespace="TcHmi.System.Localization.Function<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Package")){if(2!==pathTokens.length)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Package" localization symbol expressions must be in the form: Package::[Package-Name]::[Key]',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;localizationNamespace="TcHmi.System.Localization.Package<"+pathTokens.shift()+">",name=pathTokens.shift()}else if(namespaceToken.startsWith("Framework")){if(1!==pathTokens.length)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': "Framework" localization symbol expressions must be in the form: Framework::[Key]',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;localizationNamespace="TcHmi.System.Localization.Framework",name=pathTokens.shift()}else{if(!namespaceToken.startsWith("Application"))return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Path tokens are allowed only if the localization symbol expression starts with one of the following tokens: "Application", "Control", "Function" or "Framework".',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;if(1!==pathTokens.length)return TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_SYMBOL_INVALID_PATH,details:{code:TcHmi.Errors.E_SYMBOL_INVALID_PATH,message:TcHmi.Errors[TcHmi.Errors.E_SYMBOL_INVALID_PATH],reason:this.__printExpression(expression)+': Explicit "Application" localization symbol expressions must be in the form: Application::[Key]',domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy;localizationNamespace="TcHmi.System.Localization.Application",name=pathTokens.shift()}else;}else name=expression.getName();return name?(destroySubWatch=localizationManager.watchText(localizationNamespace,name,{level:TcHmi.Locale.Level.Application},data=>{if(this.__symbol)if(destroySubWatch||(destroySubWatch=data.destroy),data.error===TcHmi.Errors.NONE){let res={error:TcHmi.Errors.NONE,value:tchmi_clone_object(data.text),destroy};Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,{...res,expressionResolved:expression,expression:this.__symbol.getExpression()})}else{let res={error:data.error,details:{code:data.error,message:TcHmi.Errors[data.error],reason:this.__printExpression(expression)+": Failed to watch expression",domain:"TcHmi.System.Symbol",errors:data.details?[data.details]:void 0},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy};Log.debugEx("[Source=Framework, Module=TcHmi.System.Symbol, Expression=",this.__printExpression(expression),", ObjectScopeDiagGUID="+this.__symbolDiagGUID+", LogicalScopeDiagGUID="+diagGUID+"] watch tick with:",res),TcHmi.Callback.callSafeEx(callback,this.__symbol,res)}else TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.E_DESTROYED,details:{code:TcHmi.Errors.E_DESTROYED,message:TcHmi.Errors[TcHmi.Errors.E_DESTROYED],reason:this.__printExpression(expression)+": This instance was already destroyed.",domain:"TcHmi.System.SymbolTypeLocalizedText"}})}),destroy):(TcHmi.Callback.callSafeEx(callback,this.__symbol,{error:TcHmi.Errors.E_PARAMETER_INVALID,details:{code:TcHmi.Errors.E_PARAMETER_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_PARAMETER_INVALID],reason:this.__printExpression(expression)+": Could not parse name and namespace.",domain:"TcHmi.System.Symbol"},expression:this.__symbol.getExpression(),expressionResolved:expression,destroy}),destroy)}}