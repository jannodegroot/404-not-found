import"./API/Access.js";import"./API/Animation.js";import"./API/Base64BinaryReader.js";import"./API/Base64BinaryWriter.js";import"./API/Binding.js";import"./API/Callback.js";import"./API/Config.js";import"./API/Control.js";import"./API/ControlFactory.js";import"./API/Controls.js";import"./API/Decorators.js";import"./API/DialogManager.js";import"./API/Engineering.ErrorPane.js";import"./API/Environment.js";import"./API/EventProvider.js";import"./API/Exception.js";import"./API/FileUploader.js";import"./API/FilterInstance.js";import"./API/Function.js";import"./API/Functions.js";import"./API/Interval.js";import"./API/Keyboard.js";import"./API/List.js";import"./API/LocalStorage.js";import"./API/Locale.js";import"./API/Localization.js";import"./API/Log.Controls.js";import"./API/Log.js";import"./API/ObjectPath.js";import"./API/Server.ADS.js";import"./API/Server.AuditTrail.js";import"./API/Server.Domains.js";import"./API/Server.Events.js";import"./API/Server.Historize.js";import"./API/Server.RecipeManagement.js";import"./API/Server.UserManagement.js";import"./API/Server.js";import"./API/StyleProvider.js";import"./API/Symbol.js";import"./API/SymbolExpression.js";import"./API/TcSpeech.js";import"./API/Theme.Properties.js";import"./API/Theme.Resources.js";import"./API/Theme.js";import"./API/TimedAsyncTask.js";import"./API/TopMostLayer.js";import"./API/Trigger.Actions.js";import"./API/Type.Schema.js";import"./API/Type.js";import"./API/UiProvider.KeyboardProvider.js";import"./API/UiProvider.PopupProvider.js";import"./API/UiProvider.js";import"./API/ValueConverter.js";import"./API/View.js";import"./API/_TypeGuards.IFunction.js";import"./API/_TypeGuards.Trigger.js";import"./API/_TypeGuards.js";import"./System/AutomationCommandManager.js";import"./System/SymbolEventHandler.js";import{automationCommandManager}from"./System/AutomationCommandManager.js";import{buildtime,config,Data,frameworkDescription,hostPrefix,setConfig,setFrameworkDescription,setHostBaseUri,setHostPrefix,setServerSidePathAndQuery,Init as SystemInit,setIsPreloaded,setDestroyGlobalTrigger,setIsInitialized,mapControlNamesFromPackageManifestApi1ToApi0}from"./System/System.js";import{registrations as controlRegistrations}from"./API/Controls.js";import{registrations as functionRegistrations}from"./API/Functions.js";import*as Environment from"./API/Environment.js";import*as Log from"./API/Log.js";import*as DialogManager from"./API/DialogManager.js";import{dialogManager}from"./System/DialogManager.js";import{run as auditTrailRun}from"./System/AuditTrail.js";import{controlManager}from"./System/ControlManager.js";import{localizationManager}from"./System/LocalizationManager.js";import{themeManager}from"./System/ThemeManager.js";import{promiseTimeout,resolveQualifiedName}from"./System/SystemFunctions.js";import{accessManager}from"./System/AccessManager.js";import{frameworkLocalization}from"./System/Locale.js";import{serverManager}from"./System/ServerManager.js";import*as ValueConverter from"./API/ValueConverter.js";import{splashScreen}from"./System/SplashScreen.js";import{typeManager}from"./System/Type.TypeManager.js";import{internalSymbolManager}from"./System/InternalSymbolManager.js";import{timerSymbolManager}from"./System/TimerSymbolManager.js";import{intervalManager}from"./System/IntervalManager.js";import{bindingManager}from"./System/BindingManager.js";import{triggerManager}from"./System/TriggerManager.js";import{viewManager}from"./System/ViewManager.js";import{SharedResources}from"./System/SharedResources.js";import{keyboardManager}from"./System/KeyboardManager.js";import{init as symbolEventHandlerInit}from"./System/SymbolEventHandler.js";TCHMI_DYNAMIC_INSTANCE_ID=tchmi_create_guid();export function printGeneralLogInformation(){TCHMI_CONSOLE_LOG_LEVEL>=4&&(Log.debugEx("[Source=Framework, Module=TcHmi] Loading TwinCAT HMI Application"),Log.debugEx("[Source=Framework, Module=TcHmi] window.location.href:",window.location.href),Log.debugEx("[Source=Framework, Module=TcHmi] window.navigator.appName:",window.navigator.appName),Log.debugEx("[Source=Framework, Module=TcHmi] window.navigator.appCodeName:",window.navigator.appCodeName),"userAgentData"in window.navigator&&window.navigator.userAgentData?(Log.debugEx("[Source=Framework, Module=TcHmi] navigator.userAgentData.brands:",JSON.stringify(window.navigator.userAgentData?.brands)),Log.debugEx("[Source=Framework, Module=TcHmi] navigator.userAgentData.platform:",window.navigator.userAgentData?.platform),Log.debugEx("[Source=Framework, Module=TcHmi] navigator.userAgentData.mobile:",window.navigator.userAgentData?.mobile)):(Log.debugEx("[Source=Framework, Module=TcHmi] window.navigator.appVersion:",window.navigator.appVersion),Log.debugEx("[Source=Framework, Module=TcHmi] window.navigator.platform:",window.navigator.platform),Log.debugEx("[Source=Framework, Module=TcHmi] window.navigator.userAgent:",window.navigator.userAgent)),Log.debugEx("[Source=Framework, Module=TcHmi] window.navigator.cookieEnabled:",window.navigator.cookieEnabled),Log.debugEx("[Source=Framework, Module=TcHmi] window.navigator.maxTouchPoints:",window.navigator.maxTouchPoints),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_DYNAMIC_INSTANCE_ID:",TCHMI_DYNAMIC_INSTANCE_ID),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_DEBUG_TIME_LOAD_LIBRARY:",TCHMI_DEBUG_TIME_LOAD_LIBRARY),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_ENGINEERING:",TCHMI_ENGINEERING),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_DESIGNER:",TCHMI_DESIGNER),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_LIVEVIEW:",TCHMI_LIVEVIEW),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_RUNTIME:",TCHMI_RUNTIME),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_TARGET_PARTIAL:",TCHMI_TARGET_PARTIAL),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_CONFIG_OVERRIDE: ",TCHMI_CONFIG_OVERRIDE),TCHMI_ENGINEERING_WEBSOCKET?Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_ENGINEERING_WEBSOCKET:",TCHMI_ENGINEERING_WEBSOCKET):Log.debugEx("[Source=Framework, Module=TcHmi] Engineering communication will be done via server events."),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_CONSOLE_LOG_LEVEL:",TCHMI_CONSOLE_LOG_LEVEL),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_CONSOLE_LOG_PERSISTENT:",TCHMI_CONSOLE_LOG_PERSISTENT),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_CONSOLE_LOG_PERSISTENT_MAX_ENTRIES:",TCHMI_CONSOLE_LOG_PERSISTENT_MAX_ENTRIES),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_CONSOLE_LOG_TCHMISERVER_MESSAGES:",TCHMI_CONSOLE_LOG_TCHMISERVER_MESSAGES),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_LOG_ENGINEERING_COM_MESSAGES:",TCHMI_LOG_ENGINEERING_COM_MESSAGES),Log.debugEx("[Source=Framework, Module=TcHmi] TCHMI_UNITTEST_MODE:",TCHMI_UNITTEST_MODE),buildtime&&Log.debugEx("[Source=Framework, Module=TcHmi] TcHmi.System.buildtime:",buildtime))}export function printForcedLogInformation(){TCHMI_FLAG_OVERRIDES&&(TcHmi.Log.Force=!0,Log.infoEx("Overrides are used for some client flags.\nTo get rid of the flag overrides either clear the browsers localStorage entry with the key %o or reset the settings on server config page %s. The following flag overrides are currently used: %o","TCHMI_FLAG_OVERRIDES",`${Environment.getHostBaseUri()}/Config/Client`,TCHMI_FLAG_OVERRIDES),TcHmi.Log.Force=!1)}export let __initStep=0;export let __fetchFromIndexedDb=!0;export let __firstLoadAfterPublish=!1;export function prepare(){TcHmi.System??={},SharedResources.jqWindow=$(window),SharedResources.jqDocument=$(document);const pathName=window.location.pathname,dirIndex=pathName.lastIndexOf("/");if(0!==dirIndex&&setHostPrefix(pathName.substring(1,dirIndex)+":"),document.body)SharedResources.jqBody=$(document.body),SharedResources.jqBody.empty();else{const populateJqBody=function(){SharedResources.jqBody=$(document.body),SharedResources.jqBody.empty(),1e4===__initStep&&dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay)};document.addEventListener("DOMContentLoaded",populateJqBody,{once:!0})}automationCommandManager.postMessageToParent({messageType:"System.InitStageFinished",stage:"Preparing Init"})}export function run(initStep){let INIT_STAGE;Log.performanceLogStart("[Source=Framework, Module=TcHmi] INIT_OVERALL"),__initStep=initStep,function(INIT_STAGE){INIT_STAGE[INIT_STAGE.BaseConfiguration=0]="BaseConfiguration",INIT_STAGE[INIT_STAGE.PreparingSystem=1]="PreparingSystem",INIT_STAGE[INIT_STAGE.PackagesConfiguration=2]="PackagesConfiguration",INIT_STAGE[INIT_STAGE.PreparingControls=3]="PreparingControls",INIT_STAGE[INIT_STAGE.PreparingFunctions=4]="PreparingFunctions",INIT_STAGE[INIT_STAGE.Connectivity=5]="Connectivity",INIT_STAGE[INIT_STAGE.Validation=6]="Validation",INIT_STAGE[INIT_STAGE.LoadingTypeDefinitions=7]="LoadingTypeDefinitions",INIT_STAGE[INIT_STAGE.LoadingUserControls=8]="LoadingUserControls",INIT_STAGE[INIT_STAGE.LoadingContent=9]="LoadingContent",INIT_STAGE[INIT_STAGE.LoadingViews=10]="LoadingViews",INIT_STAGE[INIT_STAGE.CompilingContent=11]="CompilingContent",INIT_STAGE[INIT_STAGE.CompilingViews=12]="CompilingViews",INIT_STAGE[INIT_STAGE.PreloadingBindings=13]="PreloadingBindings",INIT_STAGE[INIT_STAGE.Finalize=14]="Finalize",INIT_STAGE[INIT_STAGE.Loaded=15]="Loaded"}(INIT_STAGE||(INIT_STAGE={}));let indexedDbRequest,initStage=INIT_STAGE.BaseConfiguration,userFunctions=[],userControlPartials=[],viewPartials=[],contentPartials=[],packageControlsLoaded=new Set,packageControls=[],packageFunctionsLoaded=new Set,packageFunctions=[],xhrCacheSuffix=TCHMI_ENGINEERING?"?preventcache="+TCHMI_DYNAMIC_INSTANCE_ID:"";const PendingCounter={PackageLoaded:2e9,BaseConfigLoaded:2e9,BaseDescriptionLoaded:2e9,BasePackageLoaded:2e9,OpenEngineeringConnection:2e9,OpenServerConnection:2e9,ControlsDescriptionLoaded:2e9,ControlsDescriptionResolved:2e9,TypeDefinitionsResolved:2e9,ServerSymbolMetaDataCacheResolved:2e9,AuditTrailInitialized:2e9,ControlsTemplatesLoaded:2e9,PackagesFunctionDescriptionLoaded:2e9,UserFunctionDescriptionLoaded:2e9,UserControlsLoaded:2e9,ContentLoaded:2e9,ViewLoaded:2e9,ContentCompiled:2e9,ViewCompiled:2e9};let initStageInfo=new Map([[INIT_STAGE.BaseConfiguration,{id:0,text:"System Configuration",toDo:2,done:0}],[INIT_STAGE.PreparingSystem,{id:1,text:"Preparing System",toDo:1,done:0}],[INIT_STAGE.PackagesConfiguration,{id:2,text:"Loading Packages",toDo:0,done:0}],[INIT_STAGE.PreparingControls,{id:3,text:"Preparing Controls",toDo:1,done:0}],[INIT_STAGE.PreparingFunctions,{id:4,text:"Preparing Functions",toDo:1,done:0}],[INIT_STAGE.Connectivity,{id:5,text:"Connectivity",toDo:2,done:0}],[INIT_STAGE.Validation,{id:6,text:"Validation",toDo:1,done:0}],[INIT_STAGE.LoadingTypeDefinitions,{id:7,text:"Type Definitions",toDo:1,done:0}],[INIT_STAGE.LoadingUserControls,{id:8,text:"Loading UserControls",toDo:0,done:0}],[INIT_STAGE.LoadingContent,{id:9,text:"Loading Content",toDo:0,done:0}],[INIT_STAGE.LoadingViews,{id:10,text:"Loading Views",toDo:0,done:0}],[INIT_STAGE.CompilingContent,{id:11,text:"Compiling Content",toDo:0,done:0}],[INIT_STAGE.CompilingViews,{id:12,text:"Compiling Views",toDo:0,done:0}],[INIT_STAGE.PreloadingBindings,{id:13,text:"Preloading Bindings",toDo:0,done:0}],[INIT_STAGE.Finalize,{id:14,text:"Finalize",toDo:1,done:0}],[INIT_STAGE.Loaded,{id:15,text:"Loaded",toDo:0,done:0}]]);const loadNextStage=newStage=>{const oldStageInfo=initStageInfo.get(initStage);if(-1===TCHMI_CONSOLE_LOG_LEVEL){const newStageInfo=initStageInfo.get(newStage);newStageInfo.startTime=performance.now(),oldStageInfo.duration=newStageInfo.startTime-oldStageInfo.startTime}automationCommandManager.postMessageToParent({messageType:"System.InitStageFinished",stage:oldStageInfo.text}),initStage=newStage},updateSplashScreen=option=>{if(TCHMI_DESIGNER||TCHMI_SINGLECONTROL)option?.callInitStateMachine&&InitStateMachine();else{if(option?.updateVersion)switch(config.splash.versionSource){case"Framework":splashScreen.updateVersionInfo("Version: "+TcHmi.version.full);break;case"Project":splashScreen.updateVersionInfo("Version: "+config.projectVersion)}if(!option?.skipStageUpdate){const stage=initStageInfo.get(initStage);if(!stage)return;splashScreen.updateStageInfo("Stage "+(stage.id+1)+" / "+initStageInfo.size+": "+stage.text),0===stage.done&&0===stage.toDo?splashScreen.updateStageProgress(100):0===stage.done&&stage.toDo>0?splashScreen.updateStageProgress(0):splashScreen.updateStageProgress(stage.done/stage.toDo*100)}option?.callInitStateMachine&&!TCHMI_UNITTEST_INIT_NO_NEXT_STAGE&&(document.hidden?InitStateMachine():setTimeout(()=>{InitStateMachine()}))}},loadPackage=function(packageInfo,callback=null){const cleanPath=tchmi_path(packageInfo.basePath+"/Manifest.json");let xhr=new XMLHttpRequest;xhr.open("GET",tchmi_encode_uri_components(cleanPath)+xhrCacheSuffix);let error=function(_evt){TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:`Failed to load package: "${packageInfo.name}" from "Properties/tchmiconfig.json". Missing "Manifest.json". Expected path: "${cleanPath}". Details: HTTP error ${xhr.status} ${xhr.statusText}`}})};xhr.addEventListener("load",function(evt){if(200!==xhr.status)return void error(evt);const manifestRes=ValueConverter.toObjectEx(xhr.responseText);let manifest=manifestRes.value;if(!manifest||!manifest.modules)return void TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:`Failed to load package: "${packageInfo.name}" from "Properties/tchmiconfig.json". Response returns no valid "Manifest.json" content. Details: ${Log.buildMessage(manifestRes.details)}`}});let packageObj={name:packageInfo.name,basePath:tchmi_path(packageInfo.basePath),manifest};if(Data.packages.has(packageObj.name))Log.warn(`[Source=Framework, Module=TcHmi] Found duplicate entry in Properties/tchmiconfig.json#package ${packageObj.name} Skipping entry.`);else if(Data.packages.set(packageObj.name,packageObj),manifest.modules.length>0)for(let i=0,ii=manifest.modules.length;i<ii;i++){let module=manifest.modules[i];if(module&&"Control"===module.type){let descrUrl=tchmi_path(packageObj.basePath+"/"+module.basePath+"/"+module.descriptionFile);if(packageControlsLoaded.has(descrUrl))continue;packageControlsLoaded.add(descrUrl),packageControls.push({package:packageObj,module})}else if(module&&"Function"===module.type){let descrUrl=tchmi_path(packageObj.basePath+"/"+module.basePath+"/"+module.descriptionFile);if(packageFunctionsLoaded.has(descrUrl))continue;packageFunctionsLoaded.add(descrUrl),packageFunctions.push({package:packageObj,module})}}Log.debug(`[Source=Framework, Module=TcHmi] Loading ${cleanPath} finished!`),TcHmi.Callback.callSafeEx(callback,null,{error:TcHmi.Errors.NONE}),manifest=null}),xhr.addEventListener("error",error),xhr.send()},InitStateMachine=function InitStateMachine(){switch(__initStep){case 1:break;case 2:{let missingBrowserFeatures=[],neededInGlobal=["WebSocket","Map","WeakMap","MutationObserver","indexedDB","Set","Promise"];for(let feature of neededInGlobal)feature in window||missingBrowserFeatures.push(feature);let neededInDiv=["replaceWith","before","after","prepend","append"];for(let feature of neededInDiv)feature in document.head||missingBrowserFeatures.push("Node."+feature);let neededInArray=["find","includes"];for(let feature of neededInArray)feature in Array.prototype||missingBrowserFeatures.push("Array.prototype."+feature);Array.from||missingBrowserFeatures.push("Array.from");let neededInString=["startsWith","endsWith","includes"];for(let feature of neededInString)feature in String.prototype||missingBrowserFeatures.push("String.prototype."+feature);if(document.head.classList){const testDiv=document.createElement("div");testDiv.classList.add("a","b"),"a b"!==testDiv.className&&missingBrowserFeatures.push("Element.classList.add with multiple arguments"),testDiv.className="a",testDiv.classList.toggle("a",!0),"a"!==testDiv.className&&missingBrowserFeatures.push("Element.classList.toggle with force")}else missingBrowserFeatures.push("Element.classList");if(missingBrowserFeatures.length>0)return Log.errorEx("[Source=Framework, Module=TcHmi] Browser does not support required features: "+missingBrowserFeatures.join(", ")),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain","Browser does not support required features: <ul><li>"+missingBrowserFeatures.join("</li>\n<li>")+"</li></ul>",{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();__initStep=3}case 3:{if(Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.BASE_CONFIGURATION"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.BASE_CONFIGURATION"),buildtime){window.localStorage.getItem(hostPrefix+"TcHmi.Init.cachedBuildtime")!==buildtime&&(__firstLoadAfterPublish=!0),window.localStorage.setItem(hostPrefix+"TcHmi.Init.cachedBuildtime",buildtime)}__initStep=1,PendingCounter.BaseConfigLoaded=1;const tchmiConfigPath="Properties/tchmiconfig.json";let xhrTcHmiConfig=new XMLHttpRequest;xhrTcHmiConfig.open("GET",tchmi_encode_uri_components(tchmiConfigPath)+xhrCacheSuffix);let xhrTcHmiConfigSuccess=function(evt){const hostBaseUri=xhrTcHmiConfig.getResponseHeader("X-Custom-Reverse-Proxy-Host-Uri");if(hostBaseUri&&(setHostBaseUri(hostBaseUri),setHostPrefix(hostBaseUri+":"),window.location.href.startsWith(hostBaseUri)&&setServerSidePathAndQuery(window.location.href.substring(hostBaseUri.length))),200!==xhrTcHmiConfig.status)return void xhrTcHmiConfigError(evt);if(1e4===__initStep)return;const configResult=ValueConverter.toObjectEx(xhrTcHmiConfig.responseText);if(configResult.error!==TcHmi.Errors.NONE||!configResult.value)return Log.error(`[Source=Framework, Module=TcHmi] Configuration file: ${xhrTcHmiConfig.responseURL||tchmiConfigPath} is not valid JSON. Details: `+Log.buildMessage(configResult.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",'Configuration file: "Properties/tchmiconfig.json" is not valid JSON.',{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();setConfig(configResult.value);for(let key in config)if(key.startsWith("__COMMENT"))return Log.error('[Source=Framework, Module=TcHmi] Configuration file: "Properties/tchmiconfig.json" is not valid. Content was not generated from "tchmiconfig.tpl.json".'),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",'Configuration file: "Properties/tchmiconfig.json" is not valid. Content was not generated from "tchmiconfig.tpl.json".',{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();config.projectVersion??="1.0.0.0",config.splash??={versionSource:"Framework"},config.basePath??="",config.scaleMode??="None",config.startupView??="",config.activeTheme??="Base",config.themes??={},config.tcHmiServer??={websocketIntervalTime:500,websocketSystemTimeout:6e4,websocketTimeout:2e4,disableOptionalSystemSubscriptions:!1},config.tcHmiServer.websocketIntervalTime||=500,config.tcHmiServer.websocketSystemTimeout||=6e4,config.tcHmiServer.websocketTimeout||=2e4,config.tcHmiServer.disableOptionalSystemSubscriptions??=!1,config.symbols??={internal:{},themedResources:{},timer:{}},config.symbols.internal??={},config.symbols.themedResources??={},config.symbols.timer??={},config.trigger??=[],config.packages??=[],config.views??=[],config.userFunctions??=[],config.userControls??=[],config.content??=[],config.actionTemplates??=[],config.intervals??={},config.languages??={},config.keyboardLayouts??=[],config.creatorSettings??={},config.creatorSettings.viewport??={defaultHeight:768,defaultWidth:1024},config.binding??={},config.binding.symbolError??="Ignore",config.binding.symbolWriteError??="ReadBack",userFunctions=[];let userFunctionsPrepared=new Set;for(const entry of tchmi_clone_object(config.userFunctions))entry.url=tchmi_path(entry.url),userFunctionsPrepared.has(entry.url)||(userFunctionsPrepared.add(entry.url),userFunctions.push(entry));userControlPartials=[];let userControlPartialsPrepared=new Set;for(const entry of tchmi_clone_object(config.userControls))entry.url=tchmi_path(entry.url),userControlPartialsPrepared.has(entry.url)||(userControlPartialsPrepared.add(entry.url),userControlPartials.push(entry));initStageInfo.get(INIT_STAGE.LoadingUserControls).toDo+=2*userControlPartials.length,contentPartials=[];let contentPartialsPrepared=new Set;for(const entry of tchmi_clone_object(config.content))entry.url=tchmi_path(entry.url),contentPartialsPrepared.has(entry.url)||(entry.preload&&(initStageInfo.get(INIT_STAGE.LoadingContent).toDo++,initStageInfo.get(INIT_STAGE.CompilingContent).toDo++,entry.keepAlive=!0),void 0===entry.keepAlive&&(entry.keepAlive=!1),!entry.keepAlive||TCHMI_DESIGNER||TCHMI_SINGLECONTROL?Data.isKeepAlivePartial.set(entry.url,!1):Data.isKeepAlivePartial.set(entry.url,!0),!0!==entry.preloadBindings||TCHMI_DESIGNER||TCHMI_SINGLECONTROL?Data.isPreloadBindingPartial.set(entry.url,!1):Data.isPreloadBindingPartial.set(entry.url,!0),Data.isLoadSyncContent.set(entry.url,entry.loadSync??!1),contentPartialsPrepared.add(entry.url),contentPartials.push(entry));PendingCounter.ContentCompiled=contentPartials.length,viewPartials=[];let viewPartialsPrepared=new Set;for(const entry of tchmi_clone_object(config.views))entry.url=tchmi_path(entry.url),viewPartialsPrepared.has(entry.url)||(entry.preload&&(initStageInfo.get(INIT_STAGE.LoadingViews).toDo++,initStageInfo.get(INIT_STAGE.CompilingViews).toDo++,entry.keepAlive=!0),void 0===entry.keepAlive&&(entry.keepAlive=!1),entry.keepAlive?Data.isKeepAlivePartial.set(entry.url,!0):Data.isKeepAlivePartial.set(entry.url,!1),!0!==entry.preloadBindings||TCHMI_DESIGNER||TCHMI_SINGLECONTROL?Data.isPreloadBindingPartial.set(entry.url,!1):Data.isPreloadBindingPartial.set(entry.url,!0),viewPartialsPrepared.add(entry.url),viewPartials.push(entry));if(PendingCounter.ViewCompiled=viewPartials.length,initStageInfo.get(INIT_STAGE.PackagesConfiguration).toDo=config.packages.length,TCHMI_ENGINEERING){const TchmiConfigOverride=TCHMI_CONFIG_OVERRIDE;TchmiConfigOverride&&(void 0!==TchmiConfigOverride.basePath&&(config.basePath=TchmiConfigOverride.basePath),TchmiConfigOverride.tcHmiServer&&TchmiConfigOverride.tcHmiServer.websocketIntervalTime&&(config.tcHmiServer.websocketIntervalTime=TchmiConfigOverride.tcHmiServer.websocketIntervalTime))}Log.debug("[Source=Framework, Module=TcHmi] Loading Properties/tchmiconfig.json finished."),PendingCounter.BaseConfigLoaded--,0===PendingCounter.BaseConfigLoaded&&(__initStep=4,updateSplashScreen({callInitStateMachine:!0}))},xhrTcHmiConfigError=function(evt){Log.error(`[Source=Framework, Module=TcHmi] Loading ${xhrTcHmiConfig.responseURL||tchmiConfigPath} failed! Details: HTTP error ${xhrTcHmiConfig.status} ${xhrTcHmiConfig.statusText}`),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",`Loading configuration file: "Properties/tchmiconfig.json" failed. Details: HTTP error ${xhrTcHmiConfig.status} ${xhrTcHmiConfig.statusText}`,{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),1e4!==__initStep&&(__initStep=1e4,updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0}))};xhrTcHmiConfig.addEventListener("load",xhrTcHmiConfigSuccess),xhrTcHmiConfig.addEventListener("error",xhrTcHmiConfigError),xhrTcHmiConfig.send()}break;case 4:{__initStep=1,Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.BASE_DESCRIPTION"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.BASE_DESCRIPTION"),PendingCounter.BaseDescriptionLoaded=1;const frameworkDescriptionPath=tchmi_path(config.basePath+"/Description.json");let xhrFwDescr=new XMLHttpRequest;xhrFwDescr.open("GET",tchmi_encode_uri_components(frameworkDescriptionPath)+xhrCacheSuffix);let xhrFwDescrSuccess=function(evt){if(200!==xhrFwDescr.status)return void xhrFwDescrError(evt);if(1e4===__initStep)return;const frameworkDescrRes=ValueConverter.toObjectEx(xhrFwDescr.responseText);if(!frameworkDescrRes.value||!frameworkDescrRes.value.version)return Log.error(`[Source=Framework, Module=TcHmi] Loading Framework description file: "${frameworkDescriptionPath}" failed. File is not a valid Framework description file. Details: ${Log.buildMessage(frameworkDescrRes.details)}`),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",`Loading Framework description file: "${frameworkDescriptionPath}" failed. File is not a valid Framework description file.`,{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();setFrameworkDescription(frameworkDescrRes.value),TcHmi.version=frameworkDescrRes.value.version,Log.debug(`[Source=Framework, Module=TcHmi] TcHmi.version.full: ${TcHmi.version.full}`),PendingCounter.BaseDescriptionLoaded--,0===PendingCounter.BaseDescriptionLoaded&&(SystemInit.__resolveInitializedBaseConfigPromise(),__initStep=5,updateSplashScreen({callInitStateMachine:!0,updateVersion:!0}))},xhrFwDescrError=function(evt){Log.error(`[Source=Framework, Module=TcHmi] Loading Framework description file: "${frameworkDescriptionPath}" failed. Details: HTTP error ${xhrFwDescr.status} ${xhrFwDescr.statusText}`),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",`Loading Framework description file: "${frameworkDescriptionPath}" failed. Details: HTTP error ${xhrFwDescr.status} ${xhrFwDescr.statusText}`,{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),1e4!==__initStep&&(__initStep=1e4,InitStateMachine())};xhrFwDescr.addEventListener("load",xhrFwDescrSuccess),xhrFwDescr.addEventListener("error",xhrFwDescrError),xhrFwDescr.send()}break;case 5:{__initStep=1,Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.BASE_PACKAGE_LOAD"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.BASE_PACKAGE_LOAD"),PendingCounter.BasePackageLoaded=1;const frameworkPackageInfo=config.packages.find(packageInfo=>"Beckhoff.TwinCAT.HMI.Framework"===packageInfo.name);if(!frameworkPackageInfo)return Log.error('[Source=Framework, Module=TcHmi] Loading Framework package "Beckhoff.TwinCAT.HMI.Framework" failed. Details: Package information in tchmiconfig.json is missing.'),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",'Loading Framework package "Beckhoff.TwinCAT.HMI.Framework" failed. Details: Package information in tchmiconfig.json is missing.',{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();loadPackage(tchmi_clone_object(frameworkPackageInfo),data=>{data.error===TcHmi.Errors.NONE?(PendingCounter.BasePackageLoaded--,initStageInfo.get(initStage).done++,PendingCounter.BasePackageLoaded<=0?(__initStep=6,updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()):(Log.error('[Source=Framework, Module=TcHmi] Loading Framework package "Beckhoff.TwinCAT.HMI.Framework" failed. Details: '+Log.buildMessage(data.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",'Loading Framework package "Beckhoff.TwinCAT.HMI.Framework" failed. Details: '+Log.buildMessage(data.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine())});break}case 6:{Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.LOCALIZATION_EARLY");for(let locale in frameworkDescription.languages){const languageEntry=tchmi_clone_object(frameworkDescription.languages[locale]);if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(config.basePath+"/"+subEntry));localizationManager.registerLocalizationFile("TcHmi.System.Localization.Framework",locale,sanitizedLanguageArray)}else localizationManager.registerLocalizationFile("TcHmi.System.Localization.Framework",locale,tchmi_path(config.basePath+"/"+languageEntry))}if(config.languagesForFramework)for(const[locale,languageEntry]of Object.entries(config.languagesForFramework))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));localizationManager.registerLocalizationFile("TcHmi.System.Localization.Framework",locale,sanitizedLanguageArray)}else localizationManager.registerLocalizationFile("TcHmi.System.Localization.Framework",locale,tchmi_path(languageEntry));let pending=0;const finalize=()=>{pending>0||(__initStep=7,updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0}))};TCHMI_DESIGNER&&(pending++,localizationManager.processLocale("en",{level:TcHmi.Locale.Level.Engineering},data=>{pending--,finalize()})),pending++,localizationManager.processLocale("en",{level:TcHmi.Locale.Level.Application},data=>{pending--,finalize()})}break;case 7:if(!document.body||!SharedResources.jqBody)return void setTimeout(()=>{__initStep=7,InitStateMachine()},25);TCHMI_DESIGNER?(document.documentElement.classList.add("tchmi-html-designer"),document.body.classList.add("tchmi-body-designer")):(document.documentElement.classList.add("tchmi-html-runtime"),document.body.classList.add("tchmi-body-runtime")),document.body.firstElementChild||document.body.firstChild?.nodeType!==Node.TEXT_NODE||(document.body.textContent=""),Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.THEME_MANAGER_EARLY"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.THEME_MANAGER_EARLY"),__initStep=1,themeManager.setTheme(config.activeTheme,!1),themeManager.processActiveTheme(()=>{SystemInit.__resolveInitializedThemesPromise(),initStageInfo.get(initStage).done++,__initStep=8,loadNextStage(INIT_STAGE.PreparingSystem),TCHMI_DESIGNER||splashScreen.show(),updateSplashScreen({callInitStateMachine:!0})});break;case 8:{__fetchFromIndexedDb=!config.disableLoadingOptimization,TCHMI_RUNTIME||(__fetchFromIndexedDb=!1);const lastLoadingUser=window.localStorage.getItem(hostPrefix+"TcHmi.Init.lastLoadingUser");if(lastLoadingUser||(__fetchFromIndexedDb=!1),!__fetchFromIndexedDb)return __initStep=9,void InitStateMachine();TcHmi.EventProvider.register("onUserChanged",(evt,currentUser)=>{if(evt.destroy(),currentUser)if(lastLoadingUser)lastLoadingUser!==currentUser&&(__fetchFromIndexedDb=!1,window.localStorage.removeItem(hostPrefix+"TcHmi.Init.lastLoadingUser"));else try{window.localStorage.setItem(hostPrefix+"TcHmi.Init.lastLoadingUser",currentUser)}catch(ex){}});const currentObjectStoreNames=["controlTemplate","contentMarkup","userControlMarkup","userControlConfig"].sort();indexedDbRequest=window.indexedDB.open(hostPrefix+"TcHmi.Init"),indexedDbRequest.onerror=function(event){indexedDbRequest=void 0},indexedDbRequest.onupgradeneeded=function(event){try{for(const name of currentObjectStoreNames){if(this.result.objectStoreNames.contains(name))try{this.result.deleteObjectStore(name)}catch(e){}this.result.createObjectStore(name)}}catch(e){}},indexedDbRequest.onsuccess=function(event){if(!buildtime)return;const deleteDatabase=!tchmi_equal(Array.from(this.result.objectStoreNames).sort(),currentObjectStoreNames);if(__firstLoadAfterPublish||deleteDatabase||!__fetchFromIndexedDb)try{if(deleteDatabase)window.localStorage.removeItem(hostPrefix+"TcHmi.Init.cachedBuildtime"),window.indexedDB.deleteDatabase(hostPrefix+"TcHmi.Init");else for(const name of currentObjectStoreNames)this.result.transaction(name,"readwrite").objectStore(name).clear()}catch(e){}else{const transaction=this.result.transaction(currentObjectStoreNames,"readonly");transaction.objectStore("controlTemplate").openCursor().onsuccess=function(event){if(!__fetchFromIndexedDb)return;const result=this.result;result&&(Data.Caches.templateMarkupCache.set(result.key,result.value),result.continue())},transaction.objectStore("userControlMarkup").openCursor().onsuccess=function(event){if(!__fetchFromIndexedDb)return;const result=this.result;result&&(Data.Caches.partialMarkupCache.set(result.key,{markup:result.value}),result.continue())},transaction.objectStore("userControlConfig").openCursor().onsuccess=function(event){if(!__fetchFromIndexedDb)return;const result=this.result;result&&(Data.Caches.partialCompositeConfigCache.set(result.key,result.value),result.continue())},transaction.objectStore("contentMarkup").openCursor().onsuccess=function(event){if(!__fetchFromIndexedDb)return;const result=this.result;result&&(Data.Caches.partialMarkupCache.set(result.key,{markup:result.value}),result.continue())}}},__initStep=9}case 9:if(__initStep=1,Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.SYSTEM_PREPARATION"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.SYSTEM_PREPARATION"),"3.7.1"!==$().jquery)return Log.error("[Source=Framework, Module=TcHmi] Mismatching jquery version. Please avoid overriding."),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain","Mismatching jQuery version. Please avoid overriding",{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();if(!document.body||!SharedResources.jqBody)return void setTimeout(()=>{__initStep=9,InitStateMachine()},25);if(keyboardManager.refreshConfig(),TCHMI_DESIGNER){const tchmiConfigOverride=TCHMI_CONFIG_OVERRIDE;tchmiConfigOverride?.tcHmiServer?.websocketOverwrite&&serverManager.setServerAddress(window.location.protocol,tchmiConfigOverride.tcHmiServer.websocketOverwrite.host??window.location.host,tchmiConfigOverride.tcHmiServer.websocketOverwrite.port)}TcHmi.EventProvider.raise("System.onInitializedServices"),__initStep=10,loadNextStage(INIT_STAGE.PackagesConfiguration),initStageInfo.get(initStage).done++,updateSplashScreen({callInitStateMachine:!0});break;case 10:{Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.PACKAGES_MANIFEST_LOAD: ${config.packages.length} Packages`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.PACKAGES_MANIFEST_LOAD"),__initStep=1;const deduplicatedPackages=new Map;for(const packageInfo of config.packages)"Beckhoff.TwinCAT.HMI.Framework"!==packageInfo.name&&deduplicatedPackages.set(packageInfo.name,packageInfo);if(PendingCounter.PackageLoaded=deduplicatedPackages.size,deduplicatedPackages.size)for(const packageInfo of deduplicatedPackages.values())loadPackage(tchmi_clone_object(packageInfo),data=>{data.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] Failed to load package: "${packageInfo.name}" from "Properties/tchmiconfig.json". Details: ${Log.buildMessage(data.details)}`),PendingCounter.PackageLoaded--,initStageInfo.get(initStage).done++,PendingCounter.PackageLoaded<=0?(Data.packages.forEach(packageIterator=>{packageIterator.manifest.modules.forEach(moduleData=>{"Package"===moduleData.type&&(Data.packages.has(moduleData.nugetId)||Log.errorEx(`[Source=Framework, Module=TcHmi] Package ${packageIterator.name} references the unknown package ${moduleData.nugetId}. Reference will be skipped.`))})}),__initStep=11,loadNextStage(INIT_STAGE.PreparingControls),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()});else __initStep=11,initStageInfo.get(initStage).done++,loadNextStage(INIT_STAGE.PreparingControls),updateSplashScreen({callInitStateMachine:!0})}break;case 11:if("complete"!==document.readyState){document.addEventListener("readystatechange",InitStateMachine,{once:!0});break}if(Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.CONTROLS_DESCRIPTION_LOAD: ${packageControls.length} Controls`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.CONTROLS_DESCRIPTION_LOAD"),__initStep=1,PendingCounter.ControlsDescriptionLoaded=packageControls.length,packageControls.length>0){const loadControlDescription=function(packageControl){packageControl.module.basePath||(packageControl.module.basePath="");const cleanPath=tchmi_path(packageControl.package.basePath+"/"+packageControl.module.basePath+"/"+packageControl.module.descriptionFile);let xhrCtrlDescr=new XMLHttpRequest;xhrCtrlDescr.open("GET",tchmi_encode_uri_components(cleanPath)+xhrCacheSuffix);let xhrCtrlDescrError=function(evt){1e4!==__initStep&&(Log.error(`[Source=Framework, Module=TcHmi] Failed to load control description: "${xhrCtrlDescr.responseURL||cleanPath}". Related control type will not be available. Details: HTTP error ${xhrCtrlDescr.status} ${xhrCtrlDescr.statusText}`),PendingCounter.ControlsDescriptionLoaded--,PendingCounter.ControlsDescriptionLoaded<=0&&(__initStep=12,updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0})))};xhrCtrlDescr.addEventListener("load",function(evt){if(200!==xhrCtrlDescr.status)return void xhrCtrlDescrError(evt);if(1e4===__initStep)return;const descrRes=ValueConverter.toObjectEx(xhrCtrlDescr.responseText);let descr=descrRes.value;if(descr&&1===packageControl.package.manifest.apiVersion){let name=descr.name;descr.apiVersion||Log.warn(`[Source=Framework, Module=TcHmi] Package: "${packageControl.package.name}": API Version mismatch. This may lead to consequential errors. Please contact the developer of the package. Control module: "${name}" has apiVersion: "0" but package has apiVersion: "1". Do not mix TwinCAT HMI 1.10 and TwinCAT 1.12 and greater API modules in one package. If the package is designed to provide TwinCAT HMI 1.10 API controls the apiVersion of the Manifest.json has to be set to "0" if it is designed to provide TwinCAT HMI 1.12 api logic remove the TwinCAT HMI 1.10 API control or set the apiVersion in Description.json to "1" if the control is designed based on TwinCAT HMI 1.12 API.`);let qname,namespace=descr.namespace;namespace&&(qname=resolveQualifiedName(name,namespace));let registration=controlRegistrations.map.get(name);if(registration&&registration.error!==TcHmi.Errors.E_NOT_UNIQUE||!qname||(registration=controlRegistrations.map.get(qname)),registration&&registration.error===TcHmi.Errors.NONE){let module={reg:registration,error:TcHmi.Errors.NONE,manifestData:packageControl.module,package:packageControl.package,description:descr,descriptionExpanded:{...tchmi_clone_object(descr),inheritationResolved:!1,inheritedTypes:[],inheritedAttributes:[],inheritedAttributesNameMap:new Map,inheritedAttributesPropertyNameMap:new Map,inheritedAttributesPropertyGetterNameMap:new Map,inheritedAttributesPropertySetterNameMap:new Map,inheritedAccess:[],inheritedEvents:[],inheritedFunctions:[],inheritedLanguages:{}}};if(Data.Modules.controls.array.push(module),registration.namespace!==namespace){let qnameErrorhandling;Log.error(`[Source=Framework, Module=TcHmi] Package: "${packageControl.package.name}": Namespace from Description.json (${namespace}) and control registration (${registration.namespace}) for control ${descr.name} are different. Please contact the developer of the package.`),namespace?qnameErrorhandling=resolveQualifiedName(name,namespace):registration.namespace&&(qnameErrorhandling=resolveQualifiedName(name,registration.namespace));let modulError={error:TcHmi.Errors.E_CONTROL_INVALID_CONFIGURATION,errorDetails:{code:TcHmi.Errors.E_CONTROL_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INVALID_CONFIGURATION],domain:"TcHmi",reason:`Namespace from Description.json (${namespace}) and control registration (${registration.namespace}) for control ${descr.name} are different.`}};Data.Modules.controls.map.set(name,modulError),qnameErrorhandling&&Data.Modules.controls.map.set(qnameErrorhandling,modulError)}else Data.Modules.controls.map.has(name)?(Data.Modules.controls.map.set(name,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Ambiguous module definitions for the name: "${name}". Please try fully qualified name.`}}),Data.Modules.controls.urlMap.delete(cleanPath)):(Data.Modules.controls.map.set(name,module),Data.Modules.controls.urlMap.set(cleanPath,module));if(qname&&(Data.Modules.controls.map.has(qname)?(Data.Modules.controls.map.set(qname,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Multiple module definitions with the name ${qname} found.`}}),Data.Modules.controls.urlMap.delete(cleanPath)):(Data.Modules.controls.map.set(qname,module),Data.Modules.controls.urlMap.set(cleanPath,module))),qname){let nameLegacy=mapControlNamesFromPackageManifestApi1ToApi0.get(qname);nameLegacy&&(Data.Modules.controls.map.has(nameLegacy)?Data.Modules.controls.map.set(nameLegacy,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Multiple module definitions with the name ${nameLegacy} found.`}}):Data.Modules.controls.map.set(nameLegacy,module))}themeManager.registerControlThemeFiles(descr)}else if(registration)registration.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] Registration of control type "${qname}" is not valid and will therefore not be available. Details: ${Log.buildMessage(registration.errorDetails)}`);else{Log.error('[Source=Framework, Module=TcHmi] Control type "'+qname+'" is not registered and will therefore not be available.\nPossible reasons:\n- Needed package is not referenced in project.\n- Related source file is not included in html document.\n- Related source file could not be loaded due to missing build or wrong/missing reference.\n- Related source file is not available (would result in console errors).\n- Related source file is not included in required order in html document (would result in console errors).\n- Related source file contains no call to "TcHmi.Controls.registerEx" or "TcHmi.Controls.register".\n- Related source file contains a call to "TcHmi.Controls.registerEx" or "TcHmi.Controls.register" with name and/or namespace not matching the definition in control description file: "'+cleanPath+'".');let modulError={error:TcHmi.Errors.E_CONTROL_INVALID_CONFIGURATION,errorDetails:{code:TcHmi.Errors.E_CONTROL_INVALID_CONFIGURATION,message:TcHmi.Errors[TcHmi.Errors.E_CONTROL_INVALID_CONFIGURATION],domain:"TcHmi",reason:`Control type "${qname}" is not registered and will therefore not be available.`}};Data.Modules.controls.urlMap.set(cleanPath,modulError)}}else if(descr){let name=descr.name,registration=controlRegistrations.map.get(name);if(registration&&registration.error===TcHmi.Errors.NONE){if(registration.directory&&registration.template){let cleanTemplatePath=tchmi_path(registration.template),cleanTemplateDirectory=tchmi_path(registration.directory);cleanTemplatePath.includes(cleanTemplateDirectory)&&(descr.template=cleanTemplatePath.replace(cleanTemplateDirectory,""))}let module={reg:registration,error:TcHmi.Errors.NONE,manifestData:packageControl.module,package:packageControl.package,description:descr,descriptionExpanded:{...tchmi_clone_object(descr),inheritationResolved:!1,inheritedTypes:[],inheritedAttributes:[],inheritedAttributesNameMap:new Map,inheritedAttributesPropertyNameMap:new Map,inheritedAttributesPropertyGetterNameMap:new Map,inheritedAttributesPropertySetterNameMap:new Map,inheritedAccess:[],inheritedEvents:[],inheritedFunctions:[],inheritedLanguages:{}}};Data.Modules.controls.array.push(module),Data.Modules.controls.map.has(name)?(Data.Modules.controls.map.set(name,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Ambiguous module definitions for the name: "${name}". Please try fully qualified name.`}}),Data.Modules.controls.urlMap.delete(cleanPath)):(Data.Modules.controls.map.set(name,module),Data.Modules.controls.urlMap.set(cleanPath,module)),themeManager.registerControlThemeFiles(descr)}else registration?registration.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] Registration of control type "${name}" is not valid and will therefore not be available. Details: ${Log.buildMessage(registration.errorDetails)}`):Log.error('[Source=Framework, Module=TcHmi] Control type "'+name+'" is not registered and will therefore not be available.\nPossible reason/s:\n- Related source file contains a call to "TcHmi.Controls.registerEx" or "TcHmi.Controls.register" with name and/or namespace not matching the definition in control description file: "'+cleanPath+'".\n- Related source file is not included in html document.\n- Related source file is not included in required order in html document (would result in console errors).\n- Related source file contains no call to "TcHmi.Controls.registerEx" or "TcHmi.Controls.register".')}else if(!descr)return Log.errorEx(`[Source=Framework, Module=TcHmi] Failed to load control description "${cleanPath}" in package ${packageControl.package.name}. Response contains no valid control description file. Details: ${Log.buildMessage(descrRes.details)}`),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Control_Description_Response_Invalid",{level:TcHmi.Locale.Level.Engineering}),cleanPath),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0});PendingCounter.ControlsDescriptionLoaded--,PendingCounter.ControlsDescriptionLoaded<=0&&(descr=null,__initStep=12,updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0}))}),xhrCtrlDescr.addEventListener("error",xhrCtrlDescrError),xhrCtrlDescr.send()};for(const packageControl of packageControls)loadControlDescription(packageControl);break}__initStep=12,updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0});break;case 12:Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.CONTROLS_DESCRIPTION_RESOLVE"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.CONTROLS_DESCRIPTION_RESOLVE"),__initStep=1,PendingCounter.ControlsDescriptionResolved=1;try{controlManager.resolveDescriptionInheritation()}catch(e){return Log.error(e),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Resolving_Control_Description_Inheritation_Failed",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine()}PendingCounter.ControlsDescriptionResolved=0,__initStep=13,updateSplashScreen({callInitStateMachine:!0});break;case 13:{if(Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.LOCALIZATION_FINAL: ${Object.keys(config.languages).length} Languages`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.LOCALIZATION_FINAL"),config.languages)for(const[key,languageEntry]of Object.entries(config.languages))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));localizationManager.registerLocalizationFile("TcHmi.System.Localization.Application",key,sanitizedLanguageArray)}else localizationManager.registerLocalizationFile("TcHmi.System.Localization.Application",key,tchmi_path(languageEntry));if(config.languageFallback&&localizationManager.setFallbackLocale(config.languageFallback),Data.packages.forEach(packageObj=>{packageObj.manifest.modules.forEach(module=>{if("Language"!==module.type)return;let files=[];if("string"==typeof module.files)files.push(tchmi_path(packageObj.basePath+"/"+module.files));else{if(!Array.isArray(module.files))return;for(let file of module.files)files.push(tchmi_path(packageObj.basePath+"/"+file))}localizationManager.registerLocalizationFile("TcHmi.System.Localization.Package<"+packageObj.name+">",module.locale,files)})}),config.languagesForPackages)for(const[name,files]of Object.entries(config.languagesForPackages))for(const[locale,languageEntry]of Object.entries(files))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Package<${name}>`,locale,sanitizedLanguageArray)}else localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Package<${name}>`,locale,tchmi_path(languageEntry));if(Data.Modules.controls.array.forEach(module=>{if(module.descriptionExpanded&&module.descriptionExpanded.languages){if(module.error!==TcHmi.Errors.NONE||!module.reg)return;if(0===module.reg.apiVersion)return;let qname=resolveQualifiedName(module.reg.name,module.reg.namespace);for(let key in module.descriptionExpanded.languages){const languageEntry=module.descriptionExpanded.languages[key];if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(TcHmi.Environment.getControlBasePath(qname)+"/"+subEntry));localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Control<${qname}>`,key,sanitizedLanguageArray)}else localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Control<${qname}>`,key,tchmi_path(TcHmi.Environment.getControlBasePath(qname)+"/"+languageEntry))}}}),config.languagesForControls)for(const[name,files]of Object.entries(config.languagesForControls))for(const[locale,languageEntry]of Object.entries(files))if(Array.isArray(languageEntry)){const sanitizedLanguageArray=[];for(const subEntry of languageEntry)sanitizedLanguageArray.push(tchmi_path(subEntry));localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Control<${name}>`,locale,sanitizedLanguageArray)}else localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Control<${name}>`,locale,tchmi_path(languageEntry));for(const module of new Set(Data.Modules.functions.map.values())){if(!(module.error===TcHmi.Errors.NONE&&module.reg&&module.package&&module.manifestData&&module.description?.languages))continue;let qname=resolveQualifiedName(module.reg.name,module.reg.namespace);for(let key in module.description.languages){const languageEntry=module.description.languages[key];if(Array.isArray(languageEntry))for(const subEntry of languageEntry)localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Function<${qname}>`,key,tchmi_path(`${module.package.basePath}/${module.manifestData.basePath}/${subEntry}`));else localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Function<${qname}>`,key,tchmi_path(`${module.package.basePath}/${module.manifestData.basePath}/${languageEntry}`))}}if(config.languagesForFunctions)for(const[name,files]of Object.entries(config.languagesForFunctions))for(const[locale,languageEntry]of Object.entries(files))if(Array.isArray(languageEntry))for(const subEntry of languageEntry)localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Function<${name}>`,locale,tchmi_path(subEntry));else localizationManager.registerLocalizationFile(`TcHmi.System.Localization.Function<${name}>`,locale,tchmi_path(languageEntry));const finalize=()=>{__initStep=15,updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0})};TCHMI_DESIGNER?localizationManager.processLocale("en",{level:TcHmi.Locale.Level.Engineering},data=>{finalize()}):finalize()}break;case 15:{Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.CONTROLS_TEMPLATES_LOAD"),__initStep=1;let templates=[];if(Data.Modules.controls.array.forEach((module,index)=>{module.descriptionExpanded&&module.descriptionExpanded.inheritedTemplate&&!templates.includes(module.descriptionExpanded.inheritedTemplate)&&templates.push(module.descriptionExpanded.inheritedTemplate)}),Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.CONTROLS_TEMPLATES_LOAD: ${templates.length} Templates`),PendingCounter.ControlsTemplatesLoaded=templates.length,templates.length>0){const loadControlTemplate=function(url){let xhrCtrlTempl=new XMLHttpRequest;xhrCtrlTempl.open("GET",tchmi_encode_uri_components(url)+xhrCacheSuffix);let xhrCtrlTemplError=function(evt){1e4!==__initStep&&(Log.error(`[Source=Framework, Module=TcHmi] Loading ${xhrCtrlTempl.responseURL||url} failed! Details: HTTP error ${xhrCtrlTempl.status} ${xhrCtrlTempl.statusText}`),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed_With_Error",{level:TcHmi.Locale.Level.Engineering}),url,`HTTP error ${xhrCtrlTempl.status} ${xhrCtrlTempl.statusText}`),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine())};xhrCtrlTempl.addEventListener("load",function(evt){200===xhrCtrlTempl.status?1e4!==__initStep&&(Data.Caches.templateMarkupCache.set(url,xhrCtrlTempl.responseText),__fetchFromIndexedDb&&"done"===indexedDbRequest?.readyState&&indexedDbRequest.result?.objectStoreNames?.contains("controlTemplate")&&indexedDbRequest.result.transaction("controlTemplate","readwrite").objectStore("controlTemplate").put(xhrCtrlTempl.responseText,url),PendingCounter.ControlsTemplatesLoaded--,PendingCounter.ControlsTemplatesLoaded<=0&&(initStageInfo.get(initStage).done++,__initStep=16,loadNextStage(INIT_STAGE.PreparingFunctions),updateSplashScreen({callInitStateMachine:!0}))):xhrCtrlTemplError(evt)}),xhrCtrlTempl.addEventListener("error",xhrCtrlTemplError),xhrCtrlTempl.send()};for(const template of templates)__fetchFromIndexedDb&&Data.Caches.templateMarkupCache.has(template)?PendingCounter.ControlsTemplatesLoaded--:loadControlTemplate(template)}PendingCounter.ControlsTemplatesLoaded<=0&&(initStageInfo.get(initStage).done++,__initStep=16,loadNextStage(INIT_STAGE.PreparingFunctions),updateSplashScreen({callInitStateMachine:!0}))}break;case 16:if("complete"!==document.readyState){document.addEventListener("readystatechange",InitStateMachine,{once:!0});break}if(Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.PACKAGES_FUNCTION_DESCRIPTION_LOAD: ${packageFunctions.length} Functions`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.PACKAGES_FUNCTION_DESCRIPTION_LOAD"),__initStep=1,PendingCounter.PackagesFunctionDescriptionLoaded=packageFunctions.length,packageFunctions.length){const loadPackageFunctionDescription=function(packageFunction){if(packageFunction.module.basePath||(packageFunction.module.basePath=""),!packageFunction.module.descriptionFile)return PendingCounter.PackagesFunctionDescriptionLoaded--,PendingCounter.PackagesFunctionDescriptionLoaded<=0?(__initStep=17,void updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0})):void 0;const cleanPath=tchmi_path(packageFunction.package.basePath+"/"+packageFunction.module.basePath+"/"+packageFunction.module.descriptionFile);let xhrPackageFunctionDescr=new XMLHttpRequest;xhrPackageFunctionDescr.open("GET",tchmi_encode_uri_components(cleanPath)+xhrCacheSuffix);let xhrPackageFunctionDescrError=function(evt){if(1e4!==__initStep)return Log.error(`[Source=Framework, Module=TcHmi] Failed to load function description: "${cleanPath}". Related functions will not be available. Details: HTTP error ${xhrPackageFunctionDescr.status} ${xhrPackageFunctionDescr.statusText}`),PendingCounter.PackagesFunctionDescriptionLoaded--,PendingCounter.PackagesFunctionDescriptionLoaded<=0?(__initStep=17,void updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0})):void 0};xhrPackageFunctionDescr.addEventListener("load",function(evt){if(200!==xhrPackageFunctionDescr.status)return void xhrPackageFunctionDescrError(evt);if(1e4===__initStep)return;const descrRes=ValueConverter.toObjectEx(xhrPackageFunctionDescr.responseText);let descr=descrRes.value;if(!descr||!descr.function)return Log.errorEx(`[Source=Framework, Module=TcHmi] Failed to load function description: "${xhrPackageFunctionDescr.responseURL||cleanPath}". Related functions will not be available. Response is no valid function JSON. Details: ${Log.buildMessage(descrRes.details)}`),PendingCounter.PackagesFunctionDescriptionLoaded--,PendingCounter.PackagesFunctionDescriptionLoaded<=0?(__initStep=17,void updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0})):void 0;let name=descr.function.name,namespace=descr.function.namespace,qname=resolveQualifiedName(name,namespace),registration=functionRegistrations.map.get(name);if(registration&&registration.error!==TcHmi.Errors.E_NOT_UNIQUE||(registration=functionRegistrations.map.get(qname)),registration&&registration.error===TcHmi.Errors.NONE){let module={reg:registration,error:TcHmi.Errors.NONE,manifestData:packageFunction.module,package:packageFunction.package,description:descr};Data.Modules.functions.map.has(name)?Data.Modules.functions.map.set(name,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Ambiguous module definitions for the name: "${name}". Please try fully qualified name.`}}):Data.Modules.functions.map.set(name,module),qname!==name&&(Data.Modules.functions.map.has(qname)?Data.Modules.functions.map.set(qname,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Multiple module definitions with the name ${qname} found.`}}):Data.Modules.functions.map.set(qname,module))}else registration?registration.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] Registration of function "${qname}" is not valid and function will therefore not be available. Details: ${Log.buildMessage(registration.errorDetails)}`):Log.error('[Source=Framework, Module=TcHmi] Function "'+qname+'" is not registered and will therefore not be available.\nPossible reason/s:\n- Source file: "'+cleanPath.replace(".function.json",".js")+'" contains a call to "TcHmi.Functions.registerFunctionEx" or "TcHmi.Functions.registerFunction" with name and/or namespace not matching the definition in function description file: "'+cleanPath+'".\n- Source file: "'+cleanPath.replace(".function.json",".js")+'" is not included in html document.\n- Source file: "'+cleanPath.replace(".function.json",".js")+'" contains no call to "TcHmi.Functions.registerFunctionEx" or "TcHmi.Functions.registerFunction".');return PendingCounter.PackagesFunctionDescriptionLoaded--,PendingCounter.PackagesFunctionDescriptionLoaded<=0?(__initStep=17,void updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0})):void 0}),xhrPackageFunctionDescr.addEventListener("error",xhrPackageFunctionDescrError),xhrPackageFunctionDescr.send()};for(let i=0,ii=packageFunctions.length;i<ii;i++)loadPackageFunctionDescription(packageFunctions[i]);break}__initStep=17,updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0});break;case 17:if("complete"!==document.readyState){document.addEventListener("readystatechange",InitStateMachine,{once:!0});break}if(Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.USER_FUNCTION_DESCRIPTION_LOAD: ${userFunctions.length} User Functions`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.USER_FUNCTION_DESCRIPTION_LOAD"),__initStep=1,PendingCounter.UserFunctionDescriptionLoaded=userFunctions.length,userFunctions.length){const loadUserFunctionDescription=function(url){const cleanPath=tchmi_path(url);let xhrUserFunctionDescr=new XMLHttpRequest;xhrUserFunctionDescr.open("GET",tchmi_encode_uri_components(url)+xhrCacheSuffix);let xhrUserFunctionDescrError=function(evt){Log.error(`[Source=Framework, Module=TcHmi] Failed to load function description: "${xhrUserFunctionDescr.responseURL||cleanPath}". Related functions will not be available. Details: HTTP error ${xhrUserFunctionDescr.status} ${xhrUserFunctionDescr.statusText}`),PendingCounter.UserFunctionDescriptionLoaded--,PendingCounter.UserFunctionDescriptionLoaded<=0&&(__initStep=19,initStageInfo.get(initStage).done++,loadNextStage(INIT_STAGE.Connectivity),updateSplashScreen({callInitStateMachine:!0}))};xhrUserFunctionDescr.addEventListener("load",function(evt){if(200!==xhrUserFunctionDescr.status)return void xhrUserFunctionDescrError(evt);const descrRes=ValueConverter.toObjectEx(xhrUserFunctionDescr.responseText);let descr=descrRes.value;if(!descr||!descr.function)return Log.errorEx(`[Source=Framework, Module=TcHmi] Failed to load function description: "${cleanPath}". Related functions will not be available. Response is no valid function JSON. Details: ${Log.buildMessage(descrRes.details)}`),PendingCounter.UserFunctionDescriptionLoaded--,PendingCounter.UserFunctionDescriptionLoaded<=0?(__initStep=19,void updateSplashScreen({callInitStateMachine:!0,skipStageUpdate:!0})):void 0;let name=descr.function.name,namespace=descr.function.namespace,qname=resolveQualifiedName(name,namespace),registration=functionRegistrations.map.get(name);if(registration&&registration.error!==TcHmi.Errors.E_NOT_UNIQUE||(registration=functionRegistrations.map.get(qname)),registration&&registration.error===TcHmi.Errors.NONE){let module={reg:registration,description:descr,error:TcHmi.Errors.NONE};Data.Modules.functions.map.has(name)?Data.Modules.functions.map.set(name,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Ambiguous module definitions for the name: "${name}". Please try fully qualified name.`}}):Data.Modules.functions.map.set(name,module),qname!==name&&(Data.Modules.functions.map.has(qname)?Data.Modules.functions.map.set(qname,{error:TcHmi.Errors.E_NOT_UNIQUE,errorDetails:{code:TcHmi.Errors.E_NOT_UNIQUE,message:TcHmi.Errors[TcHmi.Errors.E_NOT_UNIQUE],domain:"TcHmi",reason:`Multiple module definitions with the name ${qname} found.`}}):Data.Modules.functions.map.set(qname,module))}else registration?registration.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] Registration of function "${qname}" is not valid and function will therefore not be available. Details: ${Log.buildMessage(registration.errorDetails)}`):Log.error('[Source=Framework, Module=TcHmi] Function "'+qname+'" is not registered and will therefore not be available.\nPossible reason/s:\n- Source file: "'+cleanPath.replace(".function.json",".js")+'" contains a call to "TcHmi.Functions.registerFunctionEx" or "TcHmi.Functions.registerFunction" (deprecated) with name and/or namespace not matching the definition in function description file: "'+url+'".\n- Source file: "'+cleanPath.replace(".function.json",".js")+'" contains no call to "TcHmi.Functions.registerFunctionEx" or "TcHmi.Functions.registerFunction" (deprecated).\n- Source file: "'+cleanPath.replace(".function.json",".js")+'" is not included in html document.\n');PendingCounter.UserFunctionDescriptionLoaded--,PendingCounter.UserFunctionDescriptionLoaded<=0&&(__initStep=19,initStageInfo.get(initStage).done++,loadNextStage(INIT_STAGE.Connectivity),updateSplashScreen({callInitStateMachine:!0}))}),xhrUserFunctionDescr.addEventListener("error",xhrUserFunctionDescrError),xhrUserFunctionDescr.send()};for(const userFunction of userFunctions)if(userFunction.url.endsWith(".js")||userFunction.url.endsWith(".mjs")){loadUserFunctionDescription(userFunction.url.replace(".js",".function.json").replace(".mjs",".function.json"))}else Log.errorEx('[Source=Framework, Module=TcHmi] Configuration file: "Properties/tchmiconfig.json" is not valid. userFunctions includes a wrong formed entry. url must end with ".js". Reference will be skipped. Entry:',userFunction),PendingCounter.UserFunctionDescriptionLoaded--}PendingCounter.UserFunctionDescriptionLoaded<=0&&(__initStep=19,initStageInfo.get(initStage).done++,loadNextStage(INIT_STAGE.Connectivity),updateSplashScreen({callInitStateMachine:!0}));break;case 19:{Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.REGISTRATION_CHECK");const unresolvedControlRegistrations=controlRegistrations.array.filter(registeredControl=>!!registeredControl.name&&!controlManager.getDescription(resolveQualifiedName(registeredControl.name,registeredControl.namespace))),controlsWithoutMetadataNameList=[];for(const registration of unresolvedControlRegistrations)registration.name&&controlsWithoutMetadataNameList.push(resolveQualifiedName(registration.name,registration.namespace));controlsWithoutMetadataNameList.length&&Log.error("[Source=Framework, Module=TcHmi] Missing metadata for controls: "+controlsWithoutMetadataNameList.join(", ")+". Control types will not be available. Possible reasons could be: Missing entry in tchmiconfig.json#packages, incomplete Manifest.json or missing/invalid Description.json (including type=JavaScript vs type=EsModule errors)");const unresolvedFunctionRegistrations=functionRegistrations.array.filter(registeredFunction=>!!registeredFunction.name&&!Data.Modules.functions.map.has(resolveQualifiedName(registeredFunction.name,registeredFunction.namespace))),functionsWithoutMetadataNameList=[];for(const registration of unresolvedFunctionRegistrations)registration.name&&functionsWithoutMetadataNameList.push(resolveQualifiedName(registration.name,registration.namespace));functionsWithoutMetadataNameList.length&&Log.error("[Source=Framework, Module=TcHmi] Missing metadata for functions: "+functionsWithoutMetadataNameList.join(", ")+". Functions will not be available. Possible reasons could be: Missing entry in tchmiconfig.json#userFunctions, incomplete Manifest.json or missing/invalid *.function.json"),__initStep=20}case 20:Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.OPEN_SERVER_CONNECTION"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.OPEN_SERVER_CONNECTION"),__initStep=1,PendingCounter.OpenServerConnection=1,serverManager.open(resultObject=>{if(0===PendingCounter.OpenServerConnection)return;if(PendingCounter.OpenServerConnection=0,1e4===__initStep)return;SystemInit.__resolveInitializedServerCommunicationPromise();let finalized=!1;const finalize=()=>{if(!finalized){if(finalized=!0,initStageInfo.get(initStage).done++,updateSplashScreen(),resultObject.error===TcHmi.Errors.NONE)return __initStep=18,void InitStateMachine();resultObject.error===TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_CHECK_FAILED?(Log.error("[Source=Framework, Module=TcHmi] Failed to check server license: "+Log.buildMessage(resultObject.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+frameworkLocalization.getText("Server_License_Check_Failed failed",{level:TcHmi.Locale.Level.Engineering})+"<br/>\n"+TcHmi.DialogManager.buildMessage(resultObject.details)+'<br/>\n<input type="submit" value="'+frameworkLocalization.getText("Reload",{level:TcHmi.Locale.Level.Engineering})+'" style="padding:10px;" onclick="window.location.reload()">',{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})):resultObject.error===TcHmi.Errors.E_SERVER_COMMAND_ERROR?(Log.error("[Source=Framework, Module=TcHmi] Server license symbol invalid: "+Log.buildMessage(resultObject.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+frameworkLocalization.getText("Server_Command_Error",{level:TcHmi.Locale.Level.Engineering})+"<br/>\n"+TcHmi.DialogManager.buildMessage(resultObject.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})):resultObject.error===TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_LICENSE_MISSING?(Log.error("[Source=Framework, Module=TcHmi] Server license is missing: "+Log.buildMessage(resultObject.details)),TCHMI_DESIGNER?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+frameworkLocalization.getText("License_Missing",{level:TcHmi.Locale.Level.Engineering})+" "+frameworkLocalization.getText("Reopen_Editor_Window",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})):(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+frameworkLocalization.getText("License_Missing",{level:TcHmi.Locale.Level.Engineering})+"<br/>\n"+TcHmi.DialogManager.buildMessage(resultObject.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}))):resultObject.error===TcHmi.Errors.E_WEBSOCKET_OPEN_SERVER_NO_ACCESS?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+frameworkLocalization.getText("Server_Denied_Access",{level:TcHmi.Locale.Level.Engineering})+" "+tchmi_format_string(frameworkLocalization.getText("Reload_In_N_Seconds",{level:TcHmi.Locale.Level.Engineering}),"5")+"<br/>\n"+TcHmi.DialogManager.buildMessage(resultObject.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),setTimeout(function(){window.location.reload()},5e3)):TCHMI_DESIGNER?(Log.error("[Source=Framework, Module=TcHmi] Opening connection to engineering server failed: "+Log.buildMessage(resultObject.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+frameworkLocalization.getText("Please_Start_Engineering_Server",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})):(Log.error("[Source=Framework, Module=TcHmi] Opening connection to server failed: "+Log.buildMessage(resultObject.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+"<br />\n"+frameworkLocalization.getText("Possible_Reasons",{level:TcHmi.Locale.Level.Engineering})+":<br />\n- "+frameworkLocalization.getText("Possibly_Reason_Server_Websocket_Certificate_Not_Trusted",{level:TcHmi.Locale.Level.Engineering})+"<br />\n- "+tchmi_format_string(frameworkLocalization.getText("Possibly_Reason_Url_Targets_No_Running_Websocket_Server",{level:TcHmi.Locale.Level.Engineering}),resultObject.url)+"<br />\n- "+frameworkLocalization.getText("Possibly_Reason_Proxy_Problem",{level:TcHmi.Locale.Level.Engineering})+"<br />\n<br />\n"+frameworkLocalization.getText("Browser_Console_Could_Have_More_Information",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER})),__initStep=1e4,InitStateMachine()}};if(accessManager.isReady()||resultObject.error!==TcHmi.Errors.NONE)finalize();else{let timeoutId=0,destroy=TcHmi.EventProvider.register("System.onAccessManagerReady",(e,data)=>{clearTimeout(timeoutId),e.destroy(),destroy=null,finalize()});timeoutId=setTimeout(()=>{destroy&&(destroy(),destroy=null),finalize()},5e3)}});break;case 18:if(Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.OPEN_ENGINEERING_CONNECTION"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.OPEN_ENGINEERING_CONNECTION"),!TCHMI_ENGINEERING||TCHMI_SINGLECONTROL)return __initStep=14,initStageInfo.get(initStage).done++,SystemInit.__resolveInitializedCommunicationPromise(),loadNextStage(INIT_STAGE.LoadingTypeDefinitions),void updateSplashScreen({callInitStateMachine:!0});{__initStep=1,PendingCounter.OpenEngineeringConnection=1;const resourceUrl="./System/Engineering/DesignerModeComManager.js";promiseTimeout(import(resourceUrl)).catch(ex=>(Log.errorEx(`[Source=Framework, Module=TcHmi.Init] Failed to load ${resourceUrl} in Framework init:`,ex),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed_With_Error",{level:TcHmi.Locale.Level.Engineering}),resourceUrl,ex),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),PendingCounter.OpenEngineeringConnection=0,__initStep=1e4,InitStateMachine(),Promise.reject(ex))).then(module=>{module.designerModeComManager.open(resultObject=>{if(0!==PendingCounter.OpenEngineeringConnection&&1e4!==__initStep){if(resultObject.error===TcHmi.Errors.NONE)return PendingCounter.OpenEngineeringConnection=0,initStageInfo.get(initStage).done++,__initStep=14,SystemInit.__resolveInitializedCommunicationPromise(),loadNextStage(INIT_STAGE.LoadingTypeDefinitions),void updateSplashScreen({callInitStateMachine:!0});Log.error("[Source=Framework, Module=TcHmi] Communication to TwinCAT HMI Creator failed: "+Log.buildMessage(resultObject.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),TCHMI_DESIGNER?dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Engineering_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+TcHmi.DialogManager.buildMessage(resultObject.details)+"<br/>\n"+frameworkLocalization.getText("Try_Reopen_Designer_Window",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}):dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Open_Engineering_Server_Connection_Failed",{level:TcHmi.Locale.Level.Engineering})+" "+TcHmi.DialogManager.buildMessage(resultObject.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),PendingCounter.OpenEngineeringConnection=0,__initStep=1e4,InitStateMachine()}})})}break;case 14:Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.THEME_MANAGER_FINAL"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.THEME_MANAGER_FINAL"),__initStep=1,themeManager.processActiveTheme(),__initStep=21,updateSplashScreen({callInitStateMachine:!0});break;case 21:Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.TYPEDEFINITIONS"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.TYPEDEFINITIONS"),__initStep=1,PendingCounter.TypeDefinitionsResolved=1,typeManager.doWatchOrResolveSchemaDefinitions(function(data){data.error===TcHmi.Errors.NONE?(PendingCounter.TypeDefinitionsResolved=0,Log.debug("[Source=Framework, Module=TcHmi] Resolving type definitions finished."),__initStep=23):(Log.error("[Source=Framework, Module=TcHmi] Resolving type definitions failed: "+Log.buildMessage(data.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Resolving_Type_Definition_Failed",{level:TcHmi.Locale.Level.Engineering})+": "+Log.buildMessage(data.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4),InitStateMachine()});break;case 23:Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.AUDIT_TRAIL_INIT"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.AUDIT_TRAIL_INIT"),__initStep=1,PendingCounter.AuditTrailInitialized=1,auditTrailRun(()=>{0!==PendingCounter.AuditTrailInitialized&&(PendingCounter.AuditTrailInitialized=0,__initStep=22,TCHMI_UNITTEST_INIT_NO_NEXT_STAGE||InitStateMachine())});break;case 22:Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.SERVER_SYMBOL_META_DATA_CACHE"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.SERVER_SYMBOL_META_DATA_CACHE"),__initStep=1,PendingCounter.ServerSymbolMetaDataCacheResolved=1,serverManager.watchOrResolveServerSymbolMetaData(data=>{if(initStageInfo.get(initStage).done++,updateSplashScreen(),data.error===TcHmi.Errors.NONE){PendingCounter.ServerSymbolMetaDataCacheResolved=0;for(const[key,item]of Object.entries(tchmi_clone_object(config.symbols.internal)))internalSymbolManager.add(key,item);for(const[key,item]of Object.entries(tchmi_clone_object(config.symbols.timer)))timerSymbolManager.add(key,item);for(const[key,item]of Object.entries(tchmi_clone_object(config.intervals)))intervalManager.add(key,item);__initStep=24,loadNextStage(INIT_STAGE.Validation),updateSplashScreen({callInitStateMachine:!0})}else Log.error("[Source=Framework, Module=TcHmi] Resolving server symbol schema cache failed: "+Log.buildMessage(data.details)),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Resolving_Server_Symbol_Meta_Data_Cache_Failed",{level:TcHmi.Locale.Level.Engineering})+": "+Log.buildMessage(data.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine()});break;case 24:{Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.VALIDATION"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.VALIDATION");for(const module of Data.Modules.controls.array)module.description?.attributes.forEach(attribute=>{const res=typeManager.getSchemaEx(attribute.type);res.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] Attribute ${attribute.propertyName} of control `+resolveQualifiedName(module.description.name,module.description?.namespace)+` uses invalid data type ${attribute.type}: ${Log.buildMessage(res.details)}`)});const importMap=JSON.parse(document.querySelector("script[type=importmap]")?.textContent??"{}");importMap?.imports||(Log.warnEx("[Source=Framework, Module=TcHmi.Init] No modern importmap was found in HTML. Please consider upgrading TwinCAT HMI Engineering for full support of Javascript Module controls."),TCHMI_DESIGNER&&TCHMI_TARGET_PARTIAL===config.startupView&&TcHmi.Engineering.ErrorPane.add("missing-importmap","No modern importmap was found in HTML. Please consider upgrading TwinCAT HMI Engineering for full support of Javascript Module controls.",TcHmi.Engineering.ErrorPane.MessageType.Warning));for(const module of new Set(Data.Modules.functions.map.values())){if(module.error!==TcHmi.Errors.NONE||!module.description)continue;let qname=resolveQualifiedName(module.description.function.name,module.description.function.namespace);if(module.description.function.returnValue?.type){const res=typeManager.getSchemaEx(module.description.function.returnValue.type);res.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] ReturnValue of function ${qname} uses invalid data type ${module.description.function.returnValue.type}: ${Log.buildMessage(res.details)}`)}module.description.function.arguments&&module.description.function.arguments.forEach((argument,index)=>{const res=typeManager.getSchemaEx(argument.type);res.error!==TcHmi.Errors.NONE&&Log.error(`[Source=Framework, Module=TcHmi] Argument#${index} ${argument.name} of function ${qname} uses invalid data type ${argument.type}: ${Log.buildMessage(res.details)}`)})}__initStep=25,loadNextStage(INIT_STAGE.LoadingUserControls),updateSplashScreen({callInitStateMachine:!0})}break;case 25:{Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.USERCONTROL_LOAD: ${userControlPartials.length} User Controls`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.USERCONTROL_LOAD"),__initStep=1;const loadUserControlMarkup=function(urls){if(TCHMI_ENGINEERING){const resourceUrl="./System/Engineering/DesignerModePartialContentManager.js";promiseTimeout(import(resourceUrl)).catch(ex=>(Log.error(`[Source=Framework, Module=TcHmi.Init] Failed to load ${resourceUrl} in Framework init: ${ex}`),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed_With_Error",{level:TcHmi.Locale.Level.Engineering}),resourceUrl,ex),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),PendingCounter.OpenEngineeringConnection=0,__initStep=1e4,InitStateMachine(),Promise.reject(ex))).then(module=>{module.partialContentManager.requestCurrentPartialContents(urls.map(value=>({path:value})),data=>{if(data.error===TcHmi.Errors.NONE&&data.targetPartials){if(1e4===__initStep)return;for(const targetPartial of data.targetPartials)targetPartial.content&&Data.Caches.partialMarkupCache.set(targetPartial.path,{markup:targetPartial.content});initStageInfo.get(initStage).done+=Object.keys(data.targetPartials).length,PendingCounter.UserControlsLoaded-=Object.keys(data.targetPartials).length,PendingCounter.UserControlsLoaded<=0?(controlManager.resolveUcAttributes(),themeManager.retriggerUserControls(),__initStep=26,loadNextStage(INIT_STAGE.LoadingContent),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()}else{if(1e4===__initStep)return;Log.error(`[Source=Framework, Module=TcHmi] Loading usercontrols failed. Errordetail: ${Log.buildMessage(data.details)}`),data.targetPartials.find(entry=>entry.path===TCHMI_TARGET_PARTIAL)?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed",{level:TcHmi.Locale.Level.Engineering}),TCHMI_TARGET_PARTIAL),{severity:DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine()):(initStageInfo.get(initStage).done+=urls.length,PendingCounter.UserControlsLoaded-=urls.length,PendingCounter.UserControlsLoaded<=0?(controlManager.resolveUcAttributes(),themeManager.retriggerUserControls(),__initStep=26,loadNextStage(INIT_STAGE.LoadingContent),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen())}})})}else for(const url of urls){let xhrUserControl=new XMLHttpRequest;xhrUserControl.open("GET",tchmi_encode_uri_components(url)+xhrCacheSuffix);let xhrUserControlSuccess=function(evt){200===xhrUserControl.status?1e4!==__initStep&&(Data.Caches.partialMarkupCache.set(url,{markup:xhrUserControl.responseText}),__fetchFromIndexedDb&&"done"===indexedDbRequest?.readyState&&indexedDbRequest.result?.objectStoreNames?.contains("userControlMarkup")&&indexedDbRequest.result.transaction("userControlMarkup","readwrite").objectStore("userControlMarkup").put(xhrUserControl.responseText,url),initStageInfo.get(initStage).done++,PendingCounter.UserControlsLoaded--,PendingCounter.UserControlsLoaded<=0?(controlManager.resolveUcAttributes(),themeManager.retriggerUserControls(),__initStep=26,loadNextStage(INIT_STAGE.LoadingContent),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()):xhrUserControlError(evt)},xhrUserControlError=function(evt){1e4!==__initStep&&(Log.error(`[Source=Framework, Module=TcHmi] Loading ${xhrUserControl.responseURL||url} failed. Details: HTTP error ${xhrUserControl.status} ${xhrUserControl.statusText}`),url===TCHMI_TARGET_PARTIAL?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed",{level:TcHmi.Locale.Level.Engineering}),url)+" "+frameworkLocalization.getText("Propably_Syntax_Error_Html_Or_Wrong_Entry_Config",{level:TcHmi.Locale.Level.Engineering})+" "+tchmi_format_string(frameworkLocalization.getText("Details_Placeholder",{level:TcHmi.Locale.Level.Engineering}),"HTTP error "+xhrUserControl.status+" "+xhrUserControl.statusText),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine()):(PendingCounter.UserControlsLoaded--,initStageInfo.get(initStage).done++,PendingCounter.UserControlsLoaded<=0?(controlManager.resolveUcAttributes(),themeManager.retriggerUserControls(),__initStep=26,loadNextStage(INIT_STAGE.LoadingContent),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()))};xhrUserControl.addEventListener("load",xhrUserControlSuccess),xhrUserControl.addEventListener("error",xhrUserControlError),xhrUserControl.send()}},loadUserControlConfig=function(url){let xhrUserControlDescr=new XMLHttpRequest;xhrUserControlDescr.open("GET",tchmi_encode_uri_components(url)+xhrCacheSuffix);let xhrUserControlDescrError=function(evt){PendingCounter.UserControlsLoaded--,PendingCounter.UserControlsLoaded<=0&&(controlManager.resolveUcAttributes(),themeManager.retriggerUserControls(),__initStep=26,loadNextStage(INIT_STAGE.LoadingContent),updateSplashScreen({callInitStateMachine:!0}))};xhrUserControlDescr.addEventListener("load",function(evt){if(200!==xhrUserControlDescr.status)return void xhrUserControlDescrError(evt);const ucConfigRes=ValueConverter.toObjectEx(xhrUserControlDescr.responseText);let ucConfig=ucConfigRes.value;ucConfig?(Data.Caches.partialCompositeConfigCache.set(url,ucConfig),__fetchFromIndexedDb&&"done"===indexedDbRequest?.readyState&&indexedDbRequest.result?.objectStoreNames?.contains("userControlConfig")&&indexedDbRequest.result.transaction("userControlConfig","readwrite").objectStore("userControlConfig").put(ucConfig,url)):Log.error(`[Source=Framework, Module=TcHmi] Failed to load user control config: "${url}". Response is no valid user control JSON. Details: ${Log.buildMessage(ucConfigRes.details)}`),PendingCounter.UserControlsLoaded--,initStageInfo.get(initStage).done++,PendingCounter.UserControlsLoaded<=0?(controlManager.resolveUcAttributes(),themeManager.retriggerUserControls(),__initStep=26,loadNextStage(INIT_STAGE.LoadingContent),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()}),xhrUserControlDescr.addEventListener("error",xhrUserControlDescrError),xhrUserControlDescr.send()};if(PendingCounter.UserControlsLoaded=2*userControlPartials.length,userControlPartials.length>0){const urlsToFetch=[];for(const usercControlPartial of userControlPartials){if(__fetchFromIndexedDb&&Data.Caches.partialMarkupCache.has(usercControlPartial.url)?(PendingCounter.UserControlsLoaded--,initStageInfo.get(initStage).done++):urlsToFetch.push(usercControlPartial.url),!usercControlPartial.url.endsWith(".usercontrol")){Log.errorEx('[Source=Framework, Module=TcHmi] Configuration file: "Properties/tchmiconfig.json" is not valid. userControls includes a wrong formed entry. url must end with ".js". Reference will be skipped. Entry: ',usercControlPartial),PendingCounter.UserControlsLoaded--,initStageInfo.get(initStage).done++;continue}let configurl=usercControlPartial.url.replace(".usercontrol",".usercontrol.json");__fetchFromIndexedDb&&Data.Caches.partialCompositeConfigCache.has(configurl)?(PendingCounter.UserControlsLoaded--,initStageInfo.get(initStage).done++):loadUserControlConfig(configurl)}loadUserControlMarkup(urlsToFetch)}PendingCounter.UserControlsLoaded<=0&&(controlManager.resolveUcAttributes(),themeManager.retriggerUserControls(),__initStep=26,loadNextStage(INIT_STAGE.LoadingContent),updateSplashScreen({callInitStateMachine:!0}))}break;case 26:{Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.CONTENT_LOAD: ${contentPartials.length} Contents`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.CONTENT_LOAD"),__initStep=1;const loadContent=function(urls){if(TCHMI_ENGINEERING){const resourceUrl="./System/Engineering/DesignerModePartialContentManager.js";promiseTimeout(import(resourceUrl)).catch(ex=>(Log.error(`[Source=Framework, Module=TcHmi.Init] Failed to load ${resourceUrl} in Framework init: ${ex}`),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed_With_Error",{level:TcHmi.Locale.Level.Engineering}),resourceUrl,ex),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),PendingCounter.OpenEngineeringConnection=0,__initStep=1e4,InitStateMachine(),Promise.reject(ex))).then(module=>{module.partialContentManager.requestCurrentPartialContents(urls.map(value=>({path:value})),data=>{if(data.error===TcHmi.Errors.NONE&&data.targetPartials){if(1e4===__initStep)return;for(const targetPartial of data.targetPartials)targetPartial.content&&Data.Caches.partialMarkupCache.set(targetPartial.path,{markup:targetPartial.content});initStageInfo.get(initStage).done+=Object.keys(data.targetPartials).length,PendingCounter.ContentLoaded-=Object.keys(data.targetPartials).length,PendingCounter.ContentLoaded<=0?(__initStep=27,loadNextStage(INIT_STAGE.LoadingViews),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()}else{if(1e4===__initStep)return;Log.error(`[Source=Framework, Module=TcHmi] Loading content files failed. Errordetail: ${Log.buildMessage(data.details)}`),data.targetPartials.find(entry=>entry.path===TCHMI_TARGET_PARTIAL)?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed",{level:TcHmi.Locale.Level.Engineering}),TCHMI_TARGET_PARTIAL),{severity:DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine()):(PendingCounter.ContentLoaded-=urls.length,PendingCounter.ContentLoaded<=0&&(__initStep=27,loadNextStage(INIT_STAGE.LoadingViews),updateSplashScreen({callInitStateMachine:!0})))}})})}else for(const url of urls){let xhrContent=new XMLHttpRequest;xhrContent.open("GET",tchmi_encode_uri_components(url)+xhrCacheSuffix);let xhrContentSuccess=function(evt){200===xhrContent.status?1e4!==__initStep&&(Data.Caches.partialMarkupCache.set(url,{markup:xhrContent.responseText}),__fetchFromIndexedDb&&"done"===indexedDbRequest?.readyState&&indexedDbRequest.result?.objectStoreNames?.contains("contentMarkup")&&indexedDbRequest.result.transaction("contentMarkup","readwrite").objectStore("contentMarkup").put(xhrContent.responseText,url),initStageInfo.get(initStage).done++,PendingCounter.ContentLoaded--,PendingCounter.ContentLoaded<=0?(__initStep=27,loadNextStage(INIT_STAGE.LoadingViews),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()):xhrContentError(evt)},xhrContentError=function(evt){1e4!==__initStep&&(Log.error(`[Source=Framework, Module=TcHmi] Loading ${xhrContent.responseURL||url} failed. HTTP error ${xhrContent.status} ${xhrContent.statusText}`),url===TCHMI_TARGET_PARTIAL?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed",{level:TcHmi.Locale.Level.Engineering}),url)+" "+frameworkLocalization.getText("Propably_Syntax_Error_Html_Or_Wrong_Entry_Config",{level:TcHmi.Locale.Level.Engineering})+" "+tchmi_format_string(frameworkLocalization.getText("Details_Placeholder",{level:TcHmi.Locale.Level.Engineering}),`HTTP error ${xhrContent.status} ${xhrContent.statusText}`),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine()):(PendingCounter.ContentLoaded--,PendingCounter.ContentLoaded<=0&&(__initStep=27,loadNextStage(INIT_STAGE.LoadingViews),updateSplashScreen({callInitStateMachine:!0}))))};xhrContent.addEventListener("load",xhrContentSuccess),xhrContent.addEventListener("error",xhrContentError),xhrContent.send()}};if(PendingCounter.ContentLoaded=contentPartials.length,contentPartials.length>0){const urlsToFetch=[];for(const contentPartial of contentPartials)!contentPartial.preload||TCHMI_DESIGNER||TCHMI_SINGLECONTROL||TCHMI_LIVEVIEW&&contentPartial.url===TCHMI_TARGET_PARTIAL?(contentPartial.preload&&TCHMI_LIVEVIEW&&contentPartial.url===TCHMI_TARGET_PARTIAL&&(initStageInfo.get(initStage).done++,updateSplashScreen()),PendingCounter.ContentLoaded--):__fetchFromIndexedDb&&Data.Caches.partialMarkupCache.has(contentPartial.url)?(initStageInfo.get(initStage).done++,PendingCounter.ContentLoaded--):urlsToFetch.push(contentPartial.url);urlsToFetch.length&&loadContent(urlsToFetch)}PendingCounter.ContentLoaded<=0&&(__initStep=27,loadNextStage(INIT_STAGE.LoadingViews),updateSplashScreen({callInitStateMachine:!0}))}break;case 27:{Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.VIEW_LOAD: ${viewPartials.length} Views`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.VIEW_LOAD"),__initStep=1,PendingCounter.ViewLoaded=viewPartials.length;const loadView=function(urls){if(TCHMI_ENGINEERING){const resourceUrl="./System/Engineering/DesignerModePartialContentManager.js";promiseTimeout(import(resourceUrl)).catch(ex=>(Log.errorEx(`[Source=Framework, Module=TcHmi.Init] Failed to load ${resourceUrl} in Framework init:`,ex),dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed_With_Error",{level:TcHmi.Locale.Level.Engineering}),resourceUrl,ex),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),PendingCounter.OpenEngineeringConnection=0,__initStep=1e4,InitStateMachine(),Promise.reject(ex))).then(module=>{module.partialContentManager.requestCurrentPartialContents(urls.map(value=>({path:value})),data=>{if(data.error===TcHmi.Errors.NONE&&data.targetPartials){if(1e4===__initStep)return;for(const targetPartial of data.targetPartials)targetPartial.content&&Data.Caches.partialMarkupCache.set(targetPartial.path,{markup:targetPartial.content});initStageInfo.get(initStage).done+=Object.keys(data.targetPartials).length,PendingCounter.ViewLoaded-=Object.keys(data.targetPartials).length,PendingCounter.ViewLoaded<=0?(__initStep=28,loadNextStage(INIT_STAGE.CompilingContent),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()}else{if(1e4===__initStep)return;Log.error(`[Source=Framework, Module=TcHmi] Loading views failed. Errordetail: ${Log.buildMessage(data.details)}`),data.targetPartials.find(entry=>entry.path===TCHMI_TARGET_PARTIAL)?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed",{level:TcHmi.Locale.Level.Engineering}),TCHMI_TARGET_PARTIAL),{severity:DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,InitStateMachine()):(PendingCounter.ViewLoaded-=urls.length,PendingCounter.ViewLoaded<=0&&(__initStep=28,loadNextStage(INIT_STAGE.CompilingContent),updateSplashScreen({callInitStateMachine:!0})))}})})}else for(const url of urls){let xhrView=new XMLHttpRequest;xhrView.open("GET",tchmi_encode_uri_components(url)+xhrCacheSuffix);let xhrViewSuccess=function(evt){200===xhrView.status?1e4!==__initStep&&(Data.Caches.partialMarkupCache.set(url,{markup:xhrView.responseText}),initStageInfo.get(initStage).done++,PendingCounter.ViewLoaded--,PendingCounter.ViewLoaded<=0?(__initStep=28,loadNextStage(INIT_STAGE.CompilingContent),updateSplashScreen({callInitStateMachine:!0})):updateSplashScreen()):xhrViewError(evt)},xhrViewError=function(evt){if(1e4!==__initStep)return Log.error(`[Source=Framework, Module=TcHmi] Loading ${xhrView.responseURL||url} failed. Details: HTTP error ${xhrView.status} ${xhrView.statusText}`),url===TCHMI_TARGET_PARTIAL?(dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed",{level:TcHmi.Locale.Level.Engineering}),url)+" "+frameworkLocalization.getText("Propably_Syntax_Error_Html_Or_Wrong_Entry_Config",{level:TcHmi.Locale.Level.Engineering})+" "+tchmi_format_string(frameworkLocalization.getText("Details_Placeholder",{level:TcHmi.Locale.Level.Engineering}),`HTTP error ${xhrView.status} ${xhrView.statusText}`),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine()):(PendingCounter.ViewLoaded--,PendingCounter.ViewLoaded<=0?(__initStep=28,loadNextStage(INIT_STAGE.CompilingContent),void updateSplashScreen({callInitStateMachine:!0})):void 0)};xhrView.addEventListener("load",xhrViewSuccess),xhrView.addEventListener("error",xhrViewError),xhrView.send()}},urlsToFetch=[];for(const viewPartial of viewPartials)!viewPartial.preload||TCHMI_DESIGNER||TCHMI_SINGLECONTROL||TCHMI_LIVEVIEW&&viewPartial.url===TCHMI_TARGET_PARTIAL?(TCHMI_LIVEVIEW&&viewPartial.preload&&viewPartial.url===TCHMI_TARGET_PARTIAL&&(initStageInfo.get(initStage).done++,updateSplashScreen()),PendingCounter.ViewLoaded--):urlsToFetch.push(viewPartial.url);urlsToFetch.length&&loadView(urlsToFetch)}PendingCounter.ViewLoaded<=0&&(__initStep=28,loadNextStage(INIT_STAGE.CompilingContent),updateSplashScreen({callInitStateMachine:!0}));break;case 28:if(contentPartials.length&&"complete"!==document.readyState){document.addEventListener("readystatechange",InitStateMachine,{once:!0});break}if(themeManager.__asyncJsonLoadCount&&contentPartials.some(content=>content.preload)){TcHmi.EventProvider.register("System.onThemeJsonDataChanged",evt=>{evt.destroy(),InitStateMachine()});break}Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.CONTENT_COMPILE: ${contentPartials.length} Contents`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.CONTENT_COMPILE"),__initStep=1;for(let contentPartial of contentPartials)!contentPartial.preload||TCHMI_DESIGNER||TCHMI_SINGLECONTROL||TCHMI_LIVEVIEW&&contentPartial.url===TCHMI_TARGET_PARTIAL?(TCHMI_LIVEVIEW&&contentPartial.preload&&contentPartial.url===TCHMI_TARGET_PARTIAL&&(initStageInfo.get(initStage).done++,updateSplashScreen()),PendingCounter.ContentCompiled--):setTimeout(()=>{const cleanPath=contentPartial.url;let htmlFiltered=Data.Caches.partialMarkupCache.get(cleanPath);if(htmlFiltered){let tempDiv=document.createElement("div");tempDiv.innerHTML=htmlFiltered.markup;let tempContentPartial=tempDiv.firstElementChild;if(tempContentPartial){tempContentPartial.remove(),htmlFiltered.partialId=tempContentPartial.id,tempContentPartial.setAttribute("data-tchmi-partial-url",cleanPath);let contentControl=controlManager.compile(tempContentPartial).control;contentControl?.__setKeepAlive(!0)}}PendingCounter.ContentCompiled--,initStageInfo.get(initStage).done++,updateSplashScreen(),PendingCounter.ContentCompiled<=0&&(__initStep=29,loadNextStage(INIT_STAGE.CompilingViews),updateSplashScreen({callInitStateMachine:!0}))});if(PendingCounter.ContentCompiled<=0)return __initStep=29,loadNextStage(INIT_STAGE.CompilingViews),void updateSplashScreen({callInitStateMachine:!0});break;case 29:if(viewPartials.length&&"complete"!==document.readyState){document.addEventListener("readystatechange",InitStateMachine,{once:!0});break}if(viewPartials.length&&themeManager.__asyncJsonLoadCount){TcHmi.EventProvider.register("System.onThemeJsonDataChanged",evt=>{evt.destroy(),InitStateMachine()});break}Log.performanceLog(`[Source=Framework, Module=TcHmi] INIT_STATE.VIEW_COMPILE: ${viewPartials.length} Views`),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.VIEW_COMPILE"),__initStep=1;for(let viewPartial of viewPartials)!viewPartial.preload||TCHMI_DESIGNER||TCHMI_SINGLECONTROL||TCHMI_LIVEVIEW&&viewPartial.url===TCHMI_TARGET_PARTIAL?(TCHMI_LIVEVIEW&&viewPartial.preload&&viewPartial.url===TCHMI_TARGET_PARTIAL&&(initStageInfo.get(initStage).done++,updateSplashScreen()),PendingCounter.ViewCompiled--):setTimeout(()=>{const cleanPath=viewPartial.url;let htmlFiltered=Data.Caches.partialMarkupCache.get(cleanPath);if(htmlFiltered){let tempDiv=document.createElement("div");tempDiv.innerHTML=htmlFiltered.markup;let tempViewPartial=tempDiv.firstElementChild;if(tempViewPartial){tempViewPartial.remove(),tempViewPartial.setAttribute("data-tchmi-partial-url",cleanPath),htmlFiltered.partialId=tempViewPartial.id;let viewControl=controlManager.compile(tempViewPartial).control;viewControl?.__setKeepAlive(!0),htmlFiltered=void 0}}if(PendingCounter.ViewCompiled--,initStageInfo.get(initStage).done++,updateSplashScreen(),PendingCounter.ViewCompiled<=0)return __initStep=30,loadNextStage(INIT_STAGE.Finalize),void updateSplashScreen({callInitStateMachine:!0})});if(PendingCounter.ViewCompiled<=0)return __initStep=30,loadNextStage(INIT_STAGE.PreloadingBindings),void updateSplashScreen({callInitStateMachine:!0});break;case 30:{Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.PRELOAD_BINDINGS");let preloadingBindings=bindingManager.getPreloadingBindings(),preloadingBindingsDone=0;initStageInfo.get(INIT_STAGE.PreloadingBindings).done=preloadingBindingsDone;let preloadingBindingsSizeStart=preloadingBindings.size;initStageInfo.get(INIT_STAGE.PreloadingBindings).toDo=preloadingBindingsSizeStart,updateSplashScreen();const done=()=>{setIsPreloaded(!0),__initStep=1e3,loadNextStage(INIT_STAGE.Finalize),updateSplashScreen({callInitStateMachine:!0})};let destroyPreloadingBindingsWatch=bindingManager.watchPreloadingBindingDone(data=>{if(preloadingBindings.has(data.binding)&&(preloadingBindingsDone++,initStageInfo.get(INIT_STAGE.PreloadingBindings).done=preloadingBindingsDone,updateSplashScreen(),preloadingBindingsDone===preloadingBindingsSizeStart)){if(preloadingBindings=bindingManager.getPreloadingBindings(),0===preloadingBindings.size)return data.destroy?.(),void done();preloadingBindingsDone=0,initStageInfo.get(INIT_STAGE.PreloadingBindings).done=preloadingBindingsDone,preloadingBindingsSizeStart=preloadingBindings.size,initStageInfo.get(INIT_STAGE.PreloadingBindings).toDo=preloadingBindingsSizeStart,updateSplashScreen(),Array.from(preloadingBindings.values()).reverse().forEach(binding=>{const control=binding.getControl();binding.__resume({forcePreload:!0,reason:control?control.getId()+">PreloadBinding":"PreloadBinding"})})}});if(Array.from(preloadingBindings.values()).reverse().forEach(binding=>{const control=binding.getControl();binding.__resume({forcePreload:!0,reason:control?control.getId()+">PreloadBinding":"PreloadBinding"})}),0===preloadingBindings.size)return destroyPreloadingBindingsWatch(),void done()}break;case 1e3:{Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.FINAL"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.FINAL"),__initStep=1;const destroyGlobalTrigger=triggerManager.register(tchmi_clone_object(config.trigger));let vurl;if(setDestroyGlobalTrigger(destroyGlobalTrigger),TCHMI_DESIGNER)vurl=tchmi_path(TCHMI_TARGET_PARTIAL);else{const cfgvurl=config.startupView;if(!cfgvurl)return dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Startup_View_Not_Defined_Please_Configure",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();let bValid=!1;const cleanStartupPath=tchmi_path(cfgvurl);for(const viewPartial of viewPartials)if(tchmi_path(viewPartial.url)===cleanStartupPath){bValid=!0;break}if(!bValid)return dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",frameworkLocalization.getText("Unable_To_Find_View_Definition_Matching_Startup_View_Definition",{level:TcHmi.Locale.Level.Engineering}),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),__initStep=1e4,void InitStateMachine();vurl=cfgvurl}if(viewManager.setScaleMode(config.scaleMode),timerSymbolManager.run(),TCHMI_SINGLECONTROL){setIsInitialized(!0),SystemInit.__resolveInitializedPromise(),TcHmi.EventProvider.raise("onInitialized"),automationCommandManager.postMessageToParent({messageType:"System.FrameworkLoaded"});break}viewManager.loadView(vurl,function(data){if(initStageInfo.get(initStage).done++,updateSplashScreen(),data.error!==TcHmi.Errors.NONE)return dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),dialogManager.updateTextEx("__TcHmiMain",tchmi_format_string(frameworkLocalization.getText("Loading_File_Failed",{level:TcHmi.Locale.Level.Engineering}),vurl)+": "+Log.buildMessage(data.details),{severity:TcHmi.DialogManager.DialogSeverity.Error,buttonReload:!TCHMI_DESIGNER}),Log.error(`Failed to load ${vurl}: ${Log.buildMessage(data.details)}`),__initStep=1e4,void InitStateMachine();"done"!==indexedDbRequest?.readyState||indexedDbRequest.error||indexedDbRequest.result.close(),viewManager.checkBrowserFeatures(),setIsInitialized(!0),TcHmi.EventProvider.raise("onInitialized"),automationCommandManager.postMessageToParent({messageType:"System.Initialized"}),-1===TCHMI_CONSOLE_LOG_LEVEL&&performance.mark("Event: onInitialized");const mainViewCtrl=viewManager.getView();mainViewCtrl&&!mainViewCtrl.getIsAttached()&&TcHmi.EventProvider.register("System.onPrevControlsAttached",evt=>{evt.destroy(),perfReport()});const perfReport=()=>{if(-1!==TCHMI_CONSOLE_LOG_LEVEL)return;performance.mark("System.SplashScreen: finished"),Log.performanceLog(null),Log.performanceLogEnd("[Source=Framework, Module=TcHmi] INIT_OVERALL");const detail={};for(const[key,info]of initStageInfo)info.duration&&(detail[INIT_STAGE[key]]??={duration:info.duration},detail[INIT_STAGE[key]].duration=info.duration);performance.measure("[Source=Framework, Module=TcHmi] Initializing",{start:0,detail})};document.hidden?(splashScreen.hide(),loadNextStage(INIT_STAGE.Loaded),mainViewCtrl?.getIsAttached()&&perfReport()):setTimeout(()=>{splashScreen.hide(),loadNextStage(INIT_STAGE.Loaded),mainViewCtrl?.getIsAttached()&&perfReport()})})}break;case 1e4:if(splashScreen.hide(),Log.performanceLog("[Source=Framework, Module=TcHmi] INIT_STATE.ERROR"),Log.debug("[Source=Framework, Module=TcHmi] INIT_STATE.ERROR"),automationCommandManager.postMessageToParent({messageType:"System.Error",reason:dialogManager.__currentHtmlContent??""}),"loading"===document.readyState){const restartStatemaschine=function(){dialogManager.showDialog("__TcHmiMain",!0,TcHmi.DialogManager.DialogType.Overlay),InitStateMachine()};document.addEventListener("readystatechange",restartStatemaschine,{once:!0});break}Log.performanceLog(null),Log.performanceLogEnd("[Source=Framework, Module=TcHmi] INIT_OVERALL");break;default:__initStep=1}};InitStateMachine()}TCHMI_UNITTEST_MODE||queueMicrotask(()=>{symbolEventHandlerInit(),printGeneralLogInformation(),printForcedLogInformation(),prepare(),run(2)});